I"º+<h1 id="opennmtæ–°èƒ½æºæœºå™¨ç¿»è¯‘å®éªŒ">OpenNMTæ–°èƒ½æºæœºå™¨ç¿»è¯‘å®éªŒ</h1>

<h1 id="ä¸€ç¯å¢ƒå’Œæ•°æ®å‡†å¤‡">ä¸€ã€ç¯å¢ƒå’Œæ•°æ®å‡†å¤‡</h1>

<ol>
  <li>åœ¨æœåŠ¡å™¨ä¸Šæ–°å¼€ä¸€ä¸ªå«OpenNMTçš„ç¯å¢ƒï¼Œç„¶åå¼€screen</li>
  <li>å‡†å¤‡å››ä¸ªæ–‡ä»¶src-train.txtã€tgt-train.txtã€src-val.txtã€tgt-val.txtï¼Œå…¶ä¸­æ•°æ®æ˜¯ç»è¿‡åˆ†è¯ä¹‹åçš„ï¼Œç”¨onmt_preprocessè„šæœ¬å¤„ç†æ•°æ®ï¼Œå®ƒä¼šæŠŠtrainå’Œtrgï¼Œvalçš„æ–‡ä»¶å¤„ç†æˆä¸‰ä¸ªå«demo.ptçš„æ–‡ä»¶é‡Œ</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">onmt_preprocess</span> <span class="o">-</span><span class="n">train_src</span> <span class="n">data</span><span class="o">/</span><span class="n">src</span><span class="o">-</span><span class="n">train</span><span class="o">-</span><span class="n">fenci</span><span class="p">.</span><span class="n">txt</span> <span class="o">-</span><span class="n">train_tgt</span> <span class="n">data</span><span class="o">/</span><span class="n">tgt</span><span class="o">-</span><span class="n">train</span><span class="o">-</span><span class="n">fenci</span><span class="p">.</span><span class="n">txt</span> <span class="o">-</span><span class="n">valid_src</span> <span class="n">data</span><span class="o">/</span><span class="n">src</span><span class="o">-</span><span class="n">val</span><span class="o">-</span><span class="n">fenci</span><span class="p">.</span><span class="n">txt</span> <span class="o">-</span><span class="n">valid_tgt</span> <span class="n">data</span><span class="o">/</span><span class="n">tgt</span><span class="o">-</span><span class="n">val</span><span class="o">-</span><span class="n">fenci</span><span class="p">.</span><span class="n">txt</span> <span class="o">-</span><span class="n">save_data</span> <span class="n">data</span><span class="o">/</span><span class="n">demo</span>
</code></pre></div></div>

<p>PSï¼šä¹Ÿå¯ä»¥åœ¨æ•°æ®å¤„ç†ä¹‹å‰ç”¨subword-nmtè¿›è¡Œå­è¯å¤„ç†ï¼Œä½†æ˜¯æˆ‘æ²¡æœ‰è¿›è¡Œå®éªŒ</p>

<p>â€‹		bpeï¼Œsubword-nmtå­è¯å¤„ç†](https://blog.csdn.net/jmh1996/article/details/89286898)</p>

<p>â€‹		ç”Ÿæˆä¸€ä¸ªå­—å…¸</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">subword</span><span class="o">-</span><span class="n">nmt</span> <span class="n">learn</span><span class="o">-</span><span class="n">joint</span><span class="o">-</span><span class="n">bpe</span><span class="o">-</span><span class="ow">and</span><span class="o">-</span><span class="n">vocab</span> <span class="o">-</span><span class="n">i</span> <span class="n">src</span><span class="o">-</span><span class="n">train</span><span class="p">.</span><span class="n">txt</span> <span class="o">-</span><span class="n">o</span> <span class="n">src</span><span class="o">-</span><span class="n">train</span><span class="o">-</span><span class="n">code</span><span class="p">.</span><span class="nb">file</span> <span class="o">--</span><span class="n">write</span><span class="o">-</span><span class="n">vocabulary</span> <span class="n">src</span><span class="o">-</span><span class="n">train</span><span class="o">-</span><span class="n">voc</span><span class="p">.</span><span class="n">txt</span>
<span class="n">subword</span><span class="o">-</span><span class="n">nmt</span> <span class="nb">apply</span><span class="o">-</span><span class="n">bpe</span> <span class="o">-</span><span class="n">i</span> <span class="n">src</span><span class="o">-</span><span class="n">train</span><span class="p">.</span><span class="n">txt</span> <span class="o">-</span><span class="n">c</span> <span class="n">src</span><span class="o">-</span><span class="n">train</span><span class="o">-</span><span class="n">code</span><span class="p">.</span><span class="nb">file</span> <span class="o">-</span><span class="n">o</span> <span class="n">src</span><span class="o">-</span><span class="n">train</span><span class="o">-</span><span class="n">bpe</span><span class="p">.</span><span class="n">txt</span>
</code></pre></div></div>

<h1 id="äºŒè®­ç»ƒ">äºŒã€è®­ç»ƒ</h1>

<ol>
  <li>
    <p>è®­ç»ƒï¼Œä½¿ç”¨çš„æ˜¯Transformeræ¨¡å‹ï¼Œä½¿ç”¨CUDA_VISIBLE_DEVICES=1æŒ‡å®šç‰¹å®šçš„GPUï¼Œä½¿ç”¨nvidia-smiç›‘è§†GPUçš„ä½¿ç”¨ç‡ï¼Œå‡å°batch_sizeçš„å¤§å°ï¼Œä»4096åˆ°512æ‰è¡Œï¼Œè¿˜åŠ äº†logæ—¥å¿—ï¼Œè¿˜åŠ äº†tensorboardå¯è§†åŒ–ï¼Œç¾æ»‹æ»‹~</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">onmt_train</span> <span class="o">-</span><span class="n">data</span> <span class="n">data</span><span class="o">/</span><span class="n">demo</span> <span class="o">-</span><span class="n">save_model</span> <span class="n">data</span><span class="o">/</span><span class="n">OpenNMT_News_zh_en_transformer_model</span> <span class="o">-</span><span class="n">layers</span> <span class="mi">6</span> <span class="o">-</span><span class="n">rnn_size</span> <span class="mi">512</span> <span class="o">-</span><span class="n">word_vec_size</span> <span class="mi">512</span> <span class="o">-</span><span class="n">transformer_ff</span> <span class="mi">2048</span> <span class="o">-</span><span class="n">heads</span> <span class="mi">8</span>  <span class="o">-</span><span class="n">encoder_type</span> <span class="n">transformer</span> <span class="o">-</span><span class="n">decoder_type</span> <span class="n">transformer</span> <span class="o">-</span><span class="n">position_encoding</span>         <span class="o">-</span><span class="n">train_steps</span> <span class="mi">200000</span>  <span class="o">-</span><span class="n">max_generator_batches</span> <span class="mi">2</span> <span class="o">-</span><span class="n">dropout</span> <span class="mf">0.1</span>         <span class="o">-</span><span class="n">batch_size</span> <span class="mi">4096</span> <span class="o">-</span><span class="n">batch_type</span> <span class="n">tokens</span> <span class="o">-</span><span class="n">normalization</span> <span class="n">tokens</span>  <span class="o">-</span><span class="n">accum_count</span> <span class="mi">2</span>         <span class="o">-</span><span class="n">optim</span> <span class="n">adam</span> <span class="o">-</span><span class="n">adam_beta2</span> <span class="mf">0.998</span> <span class="o">-</span><span class="n">decay_method</span> <span class="n">noam</span> <span class="o">-</span><span class="n">warmup_steps</span> <span class="mi">8000</span> <span class="o">-</span><span class="n">learning_rate</span> <span class="mi">2</span>         <span class="o">-</span><span class="n">max_grad_norm</span> <span class="mi">0</span> <span class="o">-</span><span class="n">param_init</span> <span class="mi">0</span>  <span class="o">-</span><span class="n">param_init_glorot</span>         <span class="o">-</span><span class="n">label_smoothing</span> <span class="mf">0.1</span> <span class="o">-</span><span class="n">valid_steps</span> <span class="mi">2000</span> <span class="o">-</span><span class="n">save_checkpoint_steps</span> <span class="mi">2000</span> <span class="o">-</span><span class="n">gpu_ranks</span> <span class="mi">0</span>
</code></pre></div>    </div>
  </li>
</ol>

<h1 id="ä¸‰ç¿»è¯‘">ä¸‰ã€ç¿»è¯‘</h1>

<ol>
  <li>
    <p>ç¿»è¯‘</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">onmt_translate</span> <span class="o">-</span><span class="n">model</span> <span class="n">data</span><span class="o">/</span><span class="n">OpenNMT_News_zh_en_transformer_model_step_2000</span><span class="p">.</span><span class="n">pt</span> <span class="o">-</span><span class="n">src</span> <span class="n">data</span><span class="o">/</span><span class="n">src</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="n">fenci</span><span class="p">.</span><span class="n">txt</span> <span class="o">-</span><span class="n">output</span> <span class="n">data</span><span class="o">/</span><span class="n">pred</span><span class="o">-</span><span class="n">fenci</span><span class="o">-</span><span class="mf">2000.</span><span class="n">txt</span> <span class="o">-</span><span class="n">replace_unk</span> <span class="o">-</span><span class="n">verbose</span> <span class="o">-</span><span class="n">log_file</span> <span class="n">data</span><span class="o">/</span><span class="n">logoutput</span><span class="o">-</span><span class="mf">2000.</span><span class="n">log</span> <span class="o">-</span><span class="n">log_file_level</span>
</code></pre></div>    </div>
  </li>
</ol>

<h1 id="å››è¯„ä¼°">å››ã€è¯„ä¼°</h1>

<ol>
  <li>
    <p>å¯¹ç¿»è¯‘ç»“æœè¿›è¡ŒBLEUè¯„ä»·ï¼Ÿ</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">perl</span> <span class="n">multi</span><span class="o">-</span><span class="n">bleu</span><span class="p">.</span><span class="n">perl</span> <span class="n">tgt</span><span class="o">-</span><span class="n">test</span><span class="p">.</span><span class="n">txt</span> <span class="o">&lt;</span> <span class="n">pred</span><span class="o">-</span><span class="n">fenci</span><span class="o">-</span><span class="mf">12500.</span><span class="n">txt</span> <span class="o">&gt;</span> <span class="n">res</span><span class="p">.</span><span class="n">txt</span>
    
<span class="n">ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å‚è€ƒæ–‡ä»¶</span><span class="err">ï¼Œ</span><span class="n">åªéœ€è¦ç»™å‡ºå‰ç¼€</span><span class="err">ï¼Œ</span><span class="n">ç¨‹åºä¼šè‡ªåŠ¨åŠ ä¸Šæ•°å­—æ¥å¯»æ‰¾</span><span class="err">ï¼Œ</span><span class="n">å³ç¨‹åºä¼šæŸ¥æ‰¾</span> <span class="n">test</span><span class="p">.</span><span class="n">ref</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span> <span class="n">test</span><span class="p">.</span><span class="n">ref</span><span class="p">.</span><span class="mi">1</span><span class="p">,</span> <span class="err">â€¦</span>  
<span class="n">ç¬¬äºŒä¸ªå‚æ•°æ˜¯è¦è¯„ä¼°çš„æ–‡ä»¶</span><span class="err">ï¼Œ</span> <span class="o">&lt;</span> <span class="n">è¦è¿›è¡Œè¯„ä¼°çš„ç»“æœæ–‡ä»¶</span>
<span class="n">ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯å­˜æ”¾è¯„ä¼°ç»“æœçš„æ–‡ä»¶</span> <span class="o">&gt;</span> <span class="n">å­˜æ”¾è¯„ä¼°ç»“æœçš„æ–‡ä»¶</span>
    
<span class="n">BLEU</span> <span class="o">=</span> <span class="mf">4.66</span><span class="p">,</span> <span class="mf">35.2</span><span class="o">/</span><span class="mf">10.6</span><span class="o">/</span><span class="mf">4.0</span><span class="o">/</span><span class="mf">1.7</span> <span class="p">(</span><span class="n">BP</span><span class="o">=</span><span class="mf">0.655</span><span class="p">,</span> <span class="n">ratio</span><span class="o">=</span><span class="mf">0.702</span> <span class="p">,</span> <span class="n">hyp_len</span><span class="o">=</span><span class="mi">37765</span><span class="p">,</span> <span class="n">ref_len</span><span class="o">=</span><span class="mi">53761</span><span class="p">)</span>
</code></pre></div>    </div>
  </li>
</ol>

:ET