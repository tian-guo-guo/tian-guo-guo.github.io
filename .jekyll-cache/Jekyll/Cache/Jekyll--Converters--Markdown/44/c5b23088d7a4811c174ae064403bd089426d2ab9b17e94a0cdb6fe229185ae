I"²M<h1 id="fairseqæ–°èƒ½æºæœºå™¨ç¿»è¯‘å®éªŒ">Fairseqæ–°èƒ½æºæœºå™¨ç¿»è¯‘å®éªŒ</h1>

<h1 id="ä¸€æ•°æ®ä»‹ç»">ä¸€ã€æ•°æ®ä»‹ç»</h1>

<p>æ–°èƒ½æºé¢†åŸŸçš„ä¸“åˆ©æ–‡æœ¬ï¼Œå¥å­ç»è¿‡WIPOç¿»è¯‘ï¼Œé•¿åº¦æ§åˆ¶åœ¨100ä¸ªè¯ä»¥å†…ï¼Œç»è¿‡åˆæ­¥çš„æ•°æ®æ¸…æ´—ï¼ˆéä¸­è‹±å¥å¯¹ã€é¦–æœ«ç¬¦å·ç­‰ï¼‰ï¼Œå»é‡åï¼Œæœ‰ä¸­è‹±å¥å¯¹116095æ¡ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ä¸€ç§é£ç”µå‡ºåŠ›ä»¿çœŸæ¨¡æ‹Ÿæ¨¡å‹ï¼Œå…¶ç‰¹å¾åœ¨äºï¼Œé¦–å…ˆæ ¹æ®å¤šé£ç”µåœºå†å²å®æµ‹é£é€Ÿæ•°æ®æˆ–è€…é£ç”µåœºå†å²å‡ºåŠ›æ•°æ®è½¬åŒ–ï¼Œæ‹Ÿåˆé£é€ŸWeibullåˆ†å¸ƒçš„å°ºåº¦å‚æ•°cä¸å½¢çŠ¶å‚æ•°kã€é£ç”µåœºé£é€Ÿåºåˆ—è‡ªç›¸å…³ç³»æ•°ã€å¤šé£ç”µåœºä¹‹é—´é£é€Ÿç›¸å…³ç³»æ•°çŸ©é˜µ
The wind power output simulation model is characterized by comprising the following steps: firstly, converting historical actually measured wind speed data or wind power field historical output data of a wind power plant, fitting a scale parameter C of the wind speed Weibull distribution with a shape parameter K, a wind power plant wind speed sequence self-correlation coefficient and a wind speed correlation coefficient matrix between the wind power plants
</code></pre></div></div>

<ol>
  <li>
    <p>æ•°æ®å‡†å¤‡</p>
  </li>
  <li>
    <p>å‡†å¤‡ä¸­è‹±åŒè¯­æ–‡æœ¬ 116095 pairs [2]ne_zh_ok_clean.txtå’Œ[2]ne_en_ok_clean.txt</p>
  </li>
  <li>
    <p>ä¸­æ–‡åˆ†è¯ã€è‹±æ–‡Moses</p>

    <ol>
      <li>ä¸­æ–‡ï¼ˆå“ˆå·¥å¤§è¯­è¨€äº‘pyltpï¼ŒæœªåŠ æœ¯è¯­è¡¨ï¼‰</li>
      <li><a href="https://blog.csdn.net/Elenore1997/article/details/89483681">è‹±æ–‡</a></li>
    </ol>
  </li>
</ol>

<p>Normalize punctuation</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>perl /root/tian/fairseq/examples/ne_WIPO_MT/mosesdecoder/scripts/tokenizer/normalize-punctuation.perl -l en &lt; /root/tian/fairseq/examples/ne_WIPO_MT/data/[2]ne_en_ok_clean.txt &gt; /root/tian/fairseq/examples/ne_WIPO_MT/data/[2]ne_en_ok_clean.norm.en
</code></pre></div></div>

<p>Tokenizer</p>

<div class="language-perl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">perl</span> <span class="sr">/root/</span><span class="nv">tian</span><span class="sr">/fairseq/</span><span class="nv">examples</span><span class="sr">/ne_WIPO_MT/mos</span><span class="nv">esdecoder</span><span class="sr">/scripts/</span><span class="nv">tokenizer</span><span class="sr">/tokenizer.perl -a -l en &lt; /</span><span class="nv">root</span><span class="sr">/tian/</span><span class="nv">fairseq</span><span class="sr">/examples/n</span><span class="nv">e_WIPO_MT</span><span class="sr">/data/</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="nv">ne_en_ok_clean</span><span class="o">.</span><span class="nv">norm</span><span class="o">.</span><span class="nv">en</span> <span class="o">&gt;</span> <span class="sr">/root/</span><span class="nv">tian</span><span class="sr">/fairseq/</span><span class="nv">examples</span><span class="sr">/ne_WIPO_MT/da</span><span class="nv">ta</span><span class="o">/</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="nv">ne_en_ok_clean</span><span class="o">.</span><span class="nv">norm</span><span class="o">.</span><span class="nv">tok</span><span class="o">.</span><span class="nv">en</span>
</code></pre></div></div>

<ol>
  <li>
    <p>åˆ†æˆ6ä¸ªæ–‡ä»¶</p>

    <table>
      <thead>
        <tr>
          <th>1</th>
          <th>2</th>
          <th>3</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>train.zh</td>
          <td>valid.zh</td>
          <td>test.zh</td>
        </tr>
        <tr>
          <td>train.en</td>
          <td>valid.en</td>
          <td>test.en</td>
        </tr>
        <tr>
          <td>112095</td>
          <td>2000</td>
          <td>2000</td>
        </tr>
      </tbody>
    </table>

    <p>è¿è¡Œprepare_6_files.pyè„šæœ¬</p>
  </li>
  <li>
    <p>sub-BPEå¤„ç†</p>

    <p>æŠŠsubword-nmtå’Œapply_bpeç²˜è¿‡æ¥ï¼Œå¹¶ä¸”å°†ä½ç½®å¯¼å‡ºï¼ˆæ˜¯åœ¨dataæ–‡ä»¶å¤¹çš„å¤–é¢ï¼‰</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export PYTHONPATH=$(pwd)/subword-nmt:$PYTHONPATH
</code></pre></div>    </div>

    <p>æ‰“å¼€ne_testæ–‡ä»¶å¤¹ï¼Œç„¶å6ä¸ªæ–‡ä»¶æ”¾åœ¨ne_testä¸‹ï¼Œç„¶åå¯¼å‡ºä½ç½®ï¼Œæ¥ä¸‹æ¥</p>

    <p>åˆ›å»ºè¯æ±‡è¡¨</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">learn_joint_bpe_and_vocab</span> <span class="o">--</span><span class="nb">input</span> <span class="n">train</span><span class="p">.</span><span class="n">zh</span> <span class="n">train</span><span class="p">.</span><span class="n">en</span> <span class="o">-</span><span class="n">s</span> <span class="mi">32000</span> <span class="o">-</span><span class="n">o</span> <span class="n">bpe</span><span class="p">.</span><span class="n">codes</span> <span class="o">--</span><span class="n">write</span><span class="o">-</span><span class="n">vocabulary</span> <span class="n">bpe</span><span class="p">.</span><span class="n">vocab</span><span class="p">.</span><span class="n">zh</span> <span class="n">bpe</span><span class="p">.</span><span class="n">vocab</span><span class="p">.</span><span class="n">en</span>
</code></pre></div>    </div>

    <p>å°†å­—èŠ‚å¯¹ç¼–ç åº”ç”¨äºæˆ‘ä»¬çš„è®­ç»ƒã€å¼€å‘å’Œæµ‹è¯•æ•°æ®</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mkdir</span> <span class="n">ne_WIPO_BPE_zh_en</span>
<span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">apply_bpe</span> <span class="o">-</span><span class="n">c</span> <span class="n">bpe</span><span class="p">.</span><span class="n">codes</span> <span class="o">--</span><span class="n">vocabulary</span> <span class="n">bpe</span><span class="p">.</span><span class="n">vocab</span><span class="p">.</span><span class="n">zh</span> <span class="o">--</span><span class="n">vocabulary</span><span class="o">-</span><span class="n">threshold</span> <span class="mi">50</span> <span class="o">&lt;</span> <span class="n">train</span><span class="p">.</span><span class="n">zh</span> <span class="o">&gt;</span> <span class="n">ne_WIPO_BPE_zh_en</span><span class="o">/</span><span class="n">train</span><span class="p">.</span><span class="n">zh</span>
<span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">apply_bpe</span> <span class="o">-</span><span class="n">c</span> <span class="n">bpe</span><span class="p">.</span><span class="n">codes</span> <span class="o">--</span><span class="n">vocabulary</span> <span class="n">bpe</span><span class="p">.</span><span class="n">vocab</span><span class="p">.</span><span class="n">en</span> <span class="o">--</span><span class="n">vocabulary</span><span class="o">-</span><span class="n">threshold</span> <span class="mi">50</span> <span class="o">&lt;</span> <span class="n">train</span><span class="p">.</span><span class="n">en</span> <span class="o">&gt;</span> <span class="n">ne_WIPO_BPE_zh_en</span><span class="o">/</span><span class="n">train</span><span class="p">.</span><span class="n">en</span>
<span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">apply_bpe</span> <span class="o">-</span><span class="n">c</span> <span class="n">bpe</span><span class="p">.</span><span class="n">codes</span> <span class="o">--</span><span class="n">vocabulary</span> <span class="n">bpe</span><span class="p">.</span><span class="n">vocab</span><span class="p">.</span><span class="n">zh</span> <span class="o">--</span><span class="n">vocabulary</span><span class="o">-</span><span class="n">threshold</span> <span class="mi">50</span> <span class="o">&lt;</span> <span class="n">valid</span><span class="p">.</span><span class="n">zh</span> <span class="o">&gt;</span> <span class="n">ne_WIPO_BPE_zh_en</span><span class="o">/</span><span class="n">valid</span><span class="p">.</span><span class="n">zh</span>
<span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">apply_bpe</span> <span class="o">-</span><span class="n">c</span> <span class="n">bpe</span><span class="p">.</span><span class="n">codes</span> <span class="o">--</span><span class="n">vocabulary</span> <span class="n">bpe</span><span class="p">.</span><span class="n">vocab</span><span class="p">.</span><span class="n">en</span> <span class="o">--</span><span class="n">vocabulary</span><span class="o">-</span><span class="n">threshold</span> <span class="mi">50</span> <span class="o">&lt;</span> <span class="n">valid</span><span class="p">.</span><span class="n">en</span> <span class="o">&gt;</span> <span class="n">ne_WIPO_BPE_zh_en</span><span class="o">/</span><span class="n">valid</span><span class="p">.</span><span class="n">en</span>
<span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">apply_bpe</span> <span class="o">-</span><span class="n">c</span> <span class="n">bpe</span><span class="p">.</span><span class="n">codes</span> <span class="o">--</span><span class="n">vocabulary</span> <span class="n">bpe</span><span class="p">.</span><span class="n">vocab</span><span class="p">.</span><span class="n">zh</span> <span class="o">--</span><span class="n">vocabulary</span><span class="o">-</span><span class="n">threshold</span> <span class="mi">50</span> <span class="o">&lt;</span> <span class="n">test</span><span class="p">.</span><span class="n">zh</span> <span class="o">&gt;</span> <span class="n">ne_WIPO_BPE_zh_en</span><span class="o">/</span><span class="n">test</span><span class="p">.</span><span class="n">zh</span>
<span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">apply_bpe</span> <span class="o">-</span><span class="n">c</span> <span class="n">bpe</span><span class="p">.</span><span class="n">codes</span> <span class="o">--</span><span class="n">vocabulary</span> <span class="n">bpe</span><span class="p">.</span><span class="n">vocab</span><span class="p">.</span><span class="n">en</span> <span class="o">--</span><span class="n">vocabulary</span><span class="o">-</span><span class="n">threshold</span> <span class="mi">50</span> <span class="o">&lt;</span> <span class="n">test</span><span class="p">.</span><span class="n">en</span> <span class="o">&gt;</span> <span class="n">ne_WIPO_BPE_zh_en</span><span class="o">/</span><span class="n">test</span><span class="p">.</span><span class="n">en</span>
    
</code></pre></div>    </div>
  </li>
  <li>
    <p>äºŒå€¼åŒ–</p>

    <p>éœ€è¦é€€åˆ°fairseqæ–‡ä»¶å¤¹ä¸‹å»è¿è¡Œå‘½ä»¤</p>
  </li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">TEXT</span><span class="o">=</span><span class="n">examples</span><span class="o">/</span><span class="n">ne_WIPO_MT</span><span class="o">/</span><span class="n">ne_WIPO_BPE_zh_en</span>
<span class="n">fairseq</span><span class="o">-</span><span class="n">preprocess</span> <span class="o">--</span><span class="n">source</span><span class="o">-</span><span class="n">lang</span> <span class="n">zh</span> <span class="o">--</span><span class="n">target</span><span class="o">-</span><span class="n">lang</span> <span class="n">en</span> <span class="o">--</span><span class="n">trainpref</span> <span class="err">$</span><span class="n">TEXT</span><span class="o">/</span><span class="n">train</span> <span class="o">--</span><span class="n">validpref</span> <span class="err">$</span><span class="n">TEXT</span><span class="o">/</span><span class="n">valid</span> <span class="o">--</span><span class="n">testpref</span> <span class="err">$</span><span class="n">TEXT</span><span class="o">/</span><span class="n">test</span> <span class="o">--</span><span class="n">destdir</span> <span class="n">data</span><span class="o">-</span><span class="nb">bin</span><span class="o">/</span><span class="n">ne_WIPO</span><span class="p">.</span><span class="n">tokenized</span><span class="p">.</span><span class="n">zh</span><span class="o">-</span><span class="n">en</span> <span class="o">--</span><span class="n">workers</span> <span class="mi">20</span>
</code></pre></div></div>

<p>â€‹		åœ¨data-binä¸‹ä¼šç”ŸæˆäºŒå€¼åŒ–æ•°æ®</p>

<ol>
  <li>
    <p>è®­ç»ƒ</p>

    <p>â€‹	ä¸‹é¢è®­ç»ƒä¸€ä¸ªTransformeræ¨¡å‹ï¼Œè®­ç»ƒä¹‹å‰åˆ«å¿˜äº†å¼€screen</p>
  </li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">CUDA_VISIBLE_DEVICES</span><span class="o">=</span><span class="mi">1</span> <span class="n">fairseq</span><span class="o">-</span><span class="n">train</span> <span class="n">data</span><span class="o">-</span><span class="nb">bin</span><span class="o">/</span><span class="n">ne_WIPO</span><span class="p">.</span><span class="n">tokenized</span><span class="p">.</span><span class="n">zh</span><span class="o">-</span><span class="n">en</span> <span class="o">--</span><span class="n">arch</span> <span class="n">transformer</span> <span class="o">--</span><span class="n">optimizer</span> <span class="n">adam</span> <span class="o">--</span><span class="n">adam</span><span class="o">-</span><span class="n">betas</span> <span class="s">'(0.9, 0.98)'</span> <span class="o">--</span><span class="n">clip</span><span class="o">-</span><span class="n">norm</span> <span class="mf">0.0</span> <span class="o">--</span><span class="n">lr</span> <span class="mf">5e-4</span> <span class="o">--</span><span class="n">lr</span><span class="o">-</span><span class="n">scheduler</span> <span class="n">inverse_sqrt</span> <span class="o">--</span><span class="n">warmup</span><span class="o">-</span><span class="n">updates</span> <span class="mi">4000</span> <span class="o">--</span><span class="n">dropout</span> <span class="mf">0.3</span> <span class="o">--</span><span class="n">weight</span><span class="o">-</span><span class="n">decay</span> <span class="mf">0.0001</span> <span class="o">--</span><span class="n">criterion</span> <span class="n">label_smoothed_cross_entropy</span> <span class="o">--</span><span class="n">label</span><span class="o">-</span><span class="n">smoothing</span> <span class="mf">0.1</span> <span class="o">--</span><span class="nb">max</span><span class="o">-</span><span class="n">tokens</span> <span class="mi">4096</span> <span class="o">--</span><span class="nb">eval</span><span class="o">-</span><span class="n">bleu</span> <span class="o">--</span><span class="nb">eval</span><span class="o">-</span><span class="n">bleu</span><span class="o">-</span><span class="n">args</span> <span class="s">'{"beam": 5, "max_len_a": 1.2, "max_len_b": 10}'</span> <span class="o">--</span><span class="nb">eval</span><span class="o">-</span><span class="n">bleu</span><span class="o">-</span><span class="n">detok</span> <span class="n">moses</span> <span class="o">--</span><span class="nb">eval</span><span class="o">-</span><span class="n">bleu</span><span class="o">-</span><span class="n">remove</span><span class="o">-</span><span class="n">bpe</span> <span class="o">--</span><span class="nb">eval</span><span class="o">-</span><span class="n">bleu</span><span class="o">-</span><span class="k">print</span><span class="o">-</span><span class="n">samples</span> <span class="o">--</span><span class="n">best</span><span class="o">-</span><span class="n">checkpoint</span><span class="o">-</span><span class="n">metric</span> <span class="n">bleu</span> <span class="o">--</span><span class="n">maximize</span><span class="o">-</span><span class="n">best</span><span class="o">-</span><span class="n">checkpoint</span><span class="o">-</span><span class="n">metric</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">progress</span><span class="o">-</span><span class="n">bar</span> <span class="o">--</span><span class="n">log</span><span class="o">-</span><span class="n">interval</span> <span class="mi">20</span> <span class="o">--</span><span class="n">save</span><span class="o">-</span><span class="nb">dir</span> <span class="n">checkpoints_WIPO</span> <span class="o">--</span><span class="n">keep</span><span class="o">-</span><span class="n">interval</span><span class="o">-</span><span class="n">updates</span> <span class="mi">20</span> <span class="o">--</span><span class="n">tensorboard</span><span class="o">-</span><span class="n">logdir</span> <span class="n">ne_WIPO_MT</span><span class="o">-</span><span class="n">transformer</span> <span class="o">|</span> <span class="n">tee</span> <span class="n">ne_WIPO_MT</span><span class="o">-</span><span class="n">transformer</span><span class="p">.</span><span class="n">log</span>
</code></pre></div></div>

<ol>
  <li>
    <p>æ€ä¹ˆè¿›è¡Œç¿»è¯‘å‘¢ï¼Ÿ</p>

    <p>Once your model is trained, you can generate translations using <a href="https://fairseq.readthedocs.io/en/latest/command_line_tools.html#fairseq-generate">fairseq-generate</a> <strong>(for binarized data)</strong> or <a href="https://fairseq.readthedocs.io/en/latest/command_line_tools.html#fairseq-interactive"><strong>fairseq-interactive</strong></a> <strong>(for raw text)</strong>:</p>
  </li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fairseq</span><span class="o">-</span><span class="n">generate</span> <span class="n">data</span><span class="o">-</span><span class="nb">bin</span><span class="o">/</span><span class="n">ne</span><span class="p">.</span><span class="n">tokenized</span><span class="p">.</span><span class="n">zh</span><span class="o">-</span><span class="n">en</span> <span class="o">--</span><span class="n">path</span> <span class="n">checkpoints_ne2</span><span class="o">/</span><span class="n">checkpoint_best</span><span class="p">.</span><span class="n">pt</span> <span class="o">--</span><span class="n">beam</span> <span class="mi">5</span> <span class="o">--</span><span class="n">remove</span><span class="o">-</span><span class="n">bpe</span> <span class="o">&gt;</span> <span class="n">predict_test</span><span class="p">.</span><span class="n">txt</span>
</code></pre></div></div>

<p>â€‹		æ€ä¹ˆäº¤äº’å¼çš„è¿›è¡Œç¿»è¯‘å‘¢ï¼Ÿ</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fairseq</span><span class="o">-</span><span class="n">interactive</span> <span class="n">data</span><span class="o">-</span><span class="nb">bin</span><span class="o">/</span><span class="n">ne</span><span class="p">.</span><span class="n">tokenized</span><span class="p">.</span><span class="n">zh</span><span class="o">-</span><span class="n">en</span> <span class="o">--</span><span class="n">path</span> <span class="n">checkpoints_ne2</span><span class="o">/</span><span class="n">checkpoint_best</span><span class="p">.</span><span class="n">pt</span> <span class="o">--</span><span class="n">beam</span> <span class="mi">5</span> <span class="o">--</span><span class="n">remove</span><span class="o">-</span><span class="n">bpe</span>
</code></pre></div></div>

<p><img src="https://cdn.jsdelivr.net/gh/tian-guo-guo/cdn@master/assets/picgoimg/20200713163216.png" alt="image-20200713163216226" /></p>

<ol>
  <li>ç”¨tensorboardæŸ¥çœ‹è¿è¡Œè¿›åº¦</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tensorboard --logdir=./ne_WIPO_MT-transformer
</code></pre></div></div>

:ET