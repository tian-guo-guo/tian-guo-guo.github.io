I"~e<h1 id="å¦‚ä½•å®ç°ä¸€ä¸ªpromise"><a href="https://blog.fundebug.com/2017/05/25/arrow-function-for-beginner/"><strong>å¦‚ä½•å®ç°ä¸€ä¸ªPromise</strong></a></h1>

<h2 id="å¼•è¨€">å¼•è¨€</h2>

<p><code class="language-plaintext highlighter-rouge">Promise</code>å‡ºç°è§£å†³äº†jsä¸­çš„å›è°ƒåœ°ç‹±çš„é—®é¢˜ï¼Œä½¿ä»£ç æ›´ç®€æ´ï¼Œæ˜¯ES6ä¸­çš„è§„èŒƒå’Œé‡è¦ç‰¹æ€§ã€‚å®ƒçš„ä½¿ç”¨å¾ˆç®€å•ï¼Œä½†ä½ çŸ¥é“å®ƒæ˜¯æ€ä¹ˆæ ·å®ç°çš„å—~~
 ç°åœ¨æˆ‘ä»¬å°±æ¥çœ‹ä¸€ä¸‹Promiseç©¶ç«Ÿæ˜¯æ€ä¹ˆæ ·å®ç°çš„ğŸ˜„</p>

<ul>
  <li><strong>promiseè§„èŒƒ</strong>
 Promiseè§„èŒƒæ˜¯Promiseå‡½æ•°ä¸­éœ€è¦éµå¾ªçš„è§„åˆ™ï¼Œ ES6ä¸­ä½¿ç”¨çš„Promiseï¼Œå®ƒå°±æ˜¯éµå¾ª<a href="https://promisesaplus.com/">Promise/A+è§„èŒƒ</a>çš„ã€‚
 æ—¢ç„¶æ˜¯æœ‰è§„åˆ™å¯å¾ªçš„ï¼Œé‚£æˆ‘ä»¬æ ¹æ®è§„åˆ™æ¥ä¸€æ­¥æ­¥å®ç°<code class="language-plaintext highlighter-rouge">Promise</code>ã€‚</li>
</ul>

<h2 id="1åˆ›å»ºpromiseç±»">1.åˆ›å»ºPromiseç±»</h2>

<p>çœ‹ä¸€ä¸‹<code class="language-plaintext highlighter-rouge">Promise</code>æ˜¯å¦‚ä½•ä½¿ç”¨çš„</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    const promise = new Promise((resolve, reject) =&gt; {
        try {
            resolve('123');
        } catch(err) {
            reject('error');
        }
    });
    
    promise
    .then((msg) =&gt; {
        console.log(msg)
    })
å¤åˆ¶ä»£ç 
</code></pre></div></div>

<ul>
  <li>é¦–å…ˆå®ƒæ˜¯ä¸€ä¸ª<strong>æ„é€ æ–¹æ³•</strong>ï¼Œå¹¶ä¸”æ¥æ”¶ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">function</code>ä½œä¸ºå‚æ•°ï¼Œ
 è€Œè¿™ä¸ª<code class="language-plaintext highlighter-rouge">function</code>ä¸­æœ‰<code class="language-plaintext highlighter-rouge">resolve</code>å’Œ<code class="language-plaintext highlighter-rouge">reject</code>ä¸¤ä¸ªæ–¹æ³•ã€‚<code class="language-plaintext highlighter-rouge">resolve</code>ä»£è¡¨æˆåŠŸåè¿”å›çš„å€¼ï¼Œ<code class="language-plaintext highlighter-rouge">reject</code>ä»£è¡¨æ‹’ç»è¿”å›çš„åŸå› </li>
</ul>

<p>æ ¹æ®<code class="language-plaintext highlighter-rouge">Promise</code>çš„ä½¿ç”¨æ¥åˆ›å»ºä¸€ä¸ªå«<code class="language-plaintext highlighter-rouge">MyPromise</code>çš„ç±»</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    /**
     *  @params {function} callback éœ€è¦æ‰§è¡Œçš„ä¸šåŠ¡æ–¹æ³•
     */
    class MyPromise {
        // æ„é€ æ–¹æ³•æ¥æ”¶ä¸€ä¸ªfunction
        constructor(callback) {
            callback(this.resolve, this.reject); // è°ƒç”¨æ­¤function
        }
        resolve = (value) =&gt; {} // callbackä¸­æ‰§è¡Œçš„resolveæ–¹æ³•
        reject = (reason) =&gt; {} // callbackä¸­æ‰§è¡Œçš„rejectæ–¹æ³•
    }
    
    // æµ‹è¯•
    var test = new MyPromise((resolve, reject) =&gt; {
        console.log('my promise is running!');
    }) // æ‰“å°å‡º my promise is running!
å¤åˆ¶ä»£ç 
</code></pre></div></div>

<h2 id="2ä¸‰ç§çŠ¶æ€">2.ä¸‰ç§çŠ¶æ€</h2>

<p>ç°åœ¨æˆ‘ä»¬åˆ›å»ºçš„ç±»å·²ç»å¯ä»¥æ‰§è¡Œä¼ å…¥çš„æ–¹æ³•äº†ï¼Œä½†æ˜¯å®ƒä¼ å…¥çš„<code class="language-plaintext highlighter-rouge">resolve</code>å’Œ<code class="language-plaintext highlighter-rouge">reject</code>æ–¹æ³•æ˜¯æœ‰ä»€ä¹ˆç”¨çš„å‘¢ï¼Ÿ
 æˆ‘ä»¬æ¥ç€çœ‹<a href="https://promisesaplus.com/">Promiseè§„èŒƒ</a></p>

<p><img src="https://user-gold-cdn.xitu.io/2019/11/21/16e8d3e468224e0d?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img" /></p>

<ul>
  <li>æ ¹æ®è§„èŒƒå¯çŸ¥<code class="language-plaintext highlighter-rouge">Promise</code>æœ‰ä¸‰ç§çŠ¶æ€ <code class="language-plaintext highlighter-rouge">pending</code>ï¼ˆç­‰å¾…ï¼‰ï¼Œ<code class="language-plaintext highlighter-rouge">fulfilled</code>ï¼ˆå®Œæˆï¼‰ï¼Œ<code class="language-plaintext highlighter-rouge">rejected</code>ï¼ˆæ‹’ç»ï¼‰ã€‚</li>
  <li>å½“çŠ¶æ€ä¸º<code class="language-plaintext highlighter-rouge">pending</code>æ—¶ï¼ŒPromiseå¯ä»¥å˜ä¸º<code class="language-plaintext highlighter-rouge">fulfilled</code>æˆ–<code class="language-plaintext highlighter-rouge">rejected</code>çŠ¶æ€</li>
  <li>å½“çŠ¶æ€ä¸º<code class="language-plaintext highlighter-rouge">fulfilled</code>æ—¶ï¼ŒPromiseä¸èƒ½æ”¹å˜å…¶çŠ¶æ€ï¼›å¿…é¡»æœ‰å€¼ä¸”ä¸èƒ½æ”¹å˜</li>
  <li>å½“çŠ¶æ€ä¸º<code class="language-plaintext highlighter-rouge">rejected</code>æ—¶ï¼ŒPromiseä¸èƒ½æ”¹å˜å…¶çŠ¶æ€ï¼›å¿…é¡»æœ‰æ‹’ç»çš„åŸå› ä¸”ä¸èƒ½æ”¹å˜</li>
</ul>

<p>æ ¹æ®<code class="language-plaintext highlighter-rouge">Promise</code>è§„åˆ™ï¼Œæ¥ç€å†™åˆšåˆšåˆ›å»ºçš„ç±»ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    const stateArr = ['pending', 'fulfilled', 'rejected']; // ä¸‰ç§çŠ¶æ€
    /**
     *  @params {function} callback éœ€è¦æ‰§è¡Œçš„ä¸šåŠ¡æ–¹æ³•
     */
    class MyPromise {
        constructor(callback) {
            this.state = stateArr[0]; // å½“å‰çŠ¶æ€
            this.value = null; // å®Œæˆæ—¶çš„è¿”å›å€¼
            this.reason = null; // å¤±è´¥åŸå› 
            
            callback(this.resolve, this.reject); // è°ƒç”¨æ­¤function
        }
        
        // callbackä¸­æ‰§è¡Œçš„resolveæ–¹æ³•
        resolve = (value) =&gt; {
            // åˆ¤æ–­çŠ¶æ€æ˜¯å¦éœ€è¦æ˜¯pending
            if (this.state === stateArr[0]) {
               this.state = stateArr[1]; // æ›´æ–°çŠ¶æ€ä¸º fulfilled
               this.value = value; // å†™å…¥æœ€ç»ˆçš„è¿”å›å€¼
            }
        }
        
        // callbackä¸­æ‰§è¡Œçš„rejectæ–¹æ³•
        reject = (reason) =&gt; {
            // åˆ¤æ–­çŠ¶æ€æ˜¯å¦éœ€è¦æ˜¯pending
            if (this.state === stateArr[0]) {
               this.state = stateArr[2]; // æ›´æ–°çŠ¶æ€ä¸º rejected
               this.reason = reason; // å†™å…¥æ‹’ç»çš„åŸå› 
            }
        } 
    }
å¤åˆ¶ä»£ç 
</code></pre></div></div>

<p>æµ‹è¯•ä¸€ä¸‹ï¼š</p>

<p><img src="https://user-gold-cdn.xitu.io/2019/11/22/16e91fef6ecec66e?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img" /></p>

<p>å¯ä»¥çœ‹åˆ°ï¼Œè°ƒç”¨<code class="language-plaintext highlighter-rouge">resolve</code>åï¼ŒçŠ¶æ€å˜ä¸º<strong>fulfilled</strong>ï¼Œå†è°ƒç”¨<code class="language-plaintext highlighter-rouge">reject</code>æ—¶ï¼ŒçŠ¶æ€å’Œå€¼éƒ½ä¸ä¼šæ”¹å˜ï¼Œè¿™æ ·ç¬¦åˆPromiseè§„èŒƒ~~</p>

<h2 id="3thenæ–¹æ³•">3.thenæ–¹æ³•</h2>

<p>æˆ‘ä»¬çš„<code class="language-plaintext highlighter-rouge">MyPromise</code>å†™åˆ°è¿™é‡Œï¼Œä»–å·²ç»å¯ä»¥å®ç°æ›´æ–°çŠ¶æ€å’Œä¼ å€¼äº†ï¼Œä½†æ˜¯å®ƒçš„å€¼æ€ä¹ˆæ ·è¾“å‡ºç»™æˆ‘ä»¬çš„ä¸šåŠ¡å‘¢ï¼Ÿ
 ç”±<code class="language-plaintext highlighter-rouge">Promise</code>çš„ä½¿ç”¨å¯ä»¥çœ‹åˆ°ï¼Œå®ƒæ˜¯é€šè¿‡<code class="language-plaintext highlighter-rouge">then</code>æ–¹æ³•æ¥è¾“å‡ºå€¼çš„ã€‚<code class="language-plaintext highlighter-rouge">then</code>æ˜¯æ˜¯ä¸€ä¸ªå¿…è¦çš„æ–¹æ³•ï¼Œçœ‹ä¸€ä¸‹<code class="language-plaintext highlighter-rouge">then</code>çš„è§„èŒƒï¼š</p>

<p><img src="https://user-gold-cdn.xitu.io/2019/11/22/16e920775a740a45?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img" /></p>

<ul>
  <li>promiseå¿…é¡»æä¾›ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">then</code>æ–¹æ³•å»è®¿é—®ä»–çš„å½“å‰æˆ–æœ€ç»ˆçš„å€¼æˆ–åŸå› </li>
  <li>promiseä¸­<code class="language-plaintext highlighter-rouge">then</code>æ–¹æ³•æ¥æ”¶ä¸¤ä¸ªå‚æ•° <code class="language-plaintext highlighter-rouge">onFulilled</code>å’Œ<code class="language-plaintext highlighter-rouge">onRejected</code></li>
</ul>

<p>ä¸‹é¢æ˜¯å…³äº<code class="language-plaintext highlighter-rouge">onFulilled</code>å’Œ<code class="language-plaintext highlighter-rouge">onRejected</code>çš„è§„èŒƒï¼ˆéƒ¨åˆ†ï¼‰</p>

<ul>
  <li>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>onFulilled
</code></pre></div>    </div>

    <p>å’Œ</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>onRejected
</code></pre></div>    </div>

    <p>ä¸¤è€…éƒ½æ˜¯ä¸€ä¸ªå¯é€‰çš„å‚æ•°ï¼š</p>

    <ul>
      <li>å¦‚æœ<code class="language-plaintext highlighter-rouge">onFulilled</code>ä¸æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒå¿…é¡»è¢«å¿½è§†</li>
      <li>å¦‚æœ<code class="language-plaintext highlighter-rouge">onRejected</code>ä¸æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒå¿…é¡»è¢«å¿½è§†</li>
    </ul>
  </li>
  <li>
    <p>å¦‚æœ</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>onFulilled
</code></pre></div>    </div>

    <p>æ˜¯ä¸€ä¸ªå‡½æ•°ï¼š</p>

    <ul>
      <li>å®ƒå¿…é¡»åœ¨fulfilledæ—¶è¢«è°ƒç”¨ï¼Œpromiseæ–¹æ³•ä¸­çš„<code class="language-plaintext highlighter-rouge">value</code>ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°</li>
      <li>å®ƒå¿…é¡»åœ¨fulfilledä¹‹å‰<strong>ä¸</strong>è¢«è°ƒç”¨</li>
      <li>å®ƒä¸èƒ½è¢«å¤šæ¬¡è°ƒç”¨</li>
    </ul>
  </li>
  <li>
    <p>å¦‚æœ</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>onRejected
</code></pre></div>    </div>

    <p>æ˜¯ä¸€ä¸ªå‡½æ•°ï¼š</p>

    <ul>
      <li>å®ƒå¿…é¡»åœ¨rejectedæ—¶è¢«è°ƒç”¨ï¼Œpromiseæ–¹æ³•ä¸­çš„<code class="language-plaintext highlighter-rouge">reason</code>ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°</li>
      <li>å®ƒå¿…é¡»åœ¨rejectedä¹‹å‰<strong>ä¸</strong>è¢«è°ƒç”¨</li>
      <li>å®ƒä¸èƒ½è¢«å¤šæ¬¡è°ƒç”¨</li>
    </ul>
  </li>
  <li>
    <p>åœ¨æ‰§è¡Œä¸Šä¸‹æ–‡å †æ ˆä»…åŒ…å«å¹³å°ä»£ç ä¹‹å‰ï¼Œä¸èƒ½è°ƒç”¨<code class="language-plaintext highlighter-rouge">onFulfilled</code>æˆ–<code class="language-plaintext highlighter-rouge">onRejected</code></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">onFulfilled</code>å’Œ<code class="language-plaintext highlighter-rouge">onRejected</code>å¿…é¡»æ˜¯ä¸€ä¸ªå‡½æ•°</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">then</code>å¯ä»¥åœ¨åŒä¸€ä¸ªpromiseä¸­å¤šæ¬¡è¢«è°ƒç”¨</p>
  </li>
  <li><code class="language-plaintext highlighter-rouge">then</code> å¿…é¡»è¿”å›ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">promise</code></li>
</ul>

<p>æ ¹æ®thenå‡½æ•°çš„è§„åˆ™ï¼Œæˆ‘ä»¬æ¥è®¾è®¡è¿™ä¸ªthenæ–¹æ³•</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    const stateArr = ['pending', 'fulfilled', 'rejected']; // ä¸‰ç§çŠ¶æ€
    class MyPromise {
        constructor(callback) {
            this.state = stateArr[0]; // å½“å‰çŠ¶æ€
            this.value = null; // å®Œæˆæ—¶çš„è¿”å›å€¼
            this.reason = null; // å¤±è´¥åŸå› 
            
            callback(this.resolve, this.reject); // è°ƒç”¨æ­¤function
        }
        
        // callbackä¸­æ‰§è¡Œçš„resolveæ–¹æ³•
        resolve = (value) =&gt; {
            // åˆ¤æ–­çŠ¶æ€æ˜¯å¦éœ€è¦æ˜¯pending
            if (this.state === stateArr[0]) {
               this.state = stateArr[1]; // æ›´æ–°çŠ¶æ€ä¸º fulfilled
               this.value = value; // å†™å…¥æœ€ç»ˆçš„è¿”å›å€¼
            }
        }
        
        // callbackä¸­æ‰§è¡Œçš„rejectæ–¹æ³•
        reject = (reason) =&gt; {
            // åˆ¤æ–­çŠ¶æ€æ˜¯å¦éœ€è¦æ˜¯pending
            if (this.state === stateArr[0]) {
               this.state = stateArr[2]; // æ›´æ–°çŠ¶æ€ä¸º rejected
               this.reason = reason; // å†™å…¥æ‹’ç»çš„åŸå› 
            }
        }
        
        // thenæ–¹æ³•
        then = (onFulilled, onRejected) =&gt; {
            // åˆ¤æ–­onFulilled å’Œ onRejectedæ˜¯å¦æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå¦‚æœä¸æ˜¯å‡½æ•°åˆ™å¿½ç•¥å®ƒ
            onFulilled = typeof onFulilled === 'function' ? onFulilled : (value) =&gt; value;
            onRejected = typeof onRejected === 'function' ? onRejected : (reason) =&gt; reason;
            
            // å¦‚æœçŠ¶æ€æ˜¯fulfilled
            if (this.state === stateArr[1]) {
                // thenè¿”å›çš„å¿…é¡»æ˜¯ä¸€ä¸ªpromise
                return new MyPromise((resolve, reject) =&gt; {
                    try {
                        const result = onFulilled(this.value); // æ‰§è¡Œä¼ å…¥çš„onFulilledæ–¹æ³•
                        
                        // å¦‚æœonFulilledè¿”å›çš„æ˜¯ä¸€ä¸ªPromise,åˆ™è°ƒç”¨thenæ–¹æ³•
                        if (result instanceof MyPromise) {
                            result.then(resolve, reject);
                        } else {
                            resolve(result);
                        }
                    } catch(err) {
                        reject(err);
                    }
                })
            }
            
            // å¦‚æœçŠ¶æ€æ˜¯rejected
            if (this.state === stateArr[2]) {
                // thenè¿”å›çš„å¿…é¡»æ˜¯ä¸€ä¸ªpromise
                return new MyPromise((resolve, reject) =&gt; {
                    try {
                        const result = onRejected(this.reason); // æ‰§è¡Œä¼ å…¥çš„onRejectedæ–¹æ³•
                        
                        // å¦‚æœonRejectedè¿”å›çš„æ˜¯ä¸€ä¸ªPromise,åˆ™è°ƒç”¨thenæ–¹æ³•
                        if (result instanceof MyPromise) {
                            result.then(resolve, reject);
                        } else {
                            resolve(result);
                        }
                    } catch(err) {
                        reject(err);
                    }
                })
            }
        }
    }

å¤åˆ¶ä»£ç 
</code></pre></div></div>

<p>æµ‹è¯•ä¸€ä¸‹ï¼š</p>

<p>æˆåŠŸè¿”å›ï¼š</p>

<p><img src="https://user-gold-cdn.xitu.io/2019/11/22/16e927ecf47fee96?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img" /></p>

<p>å¤±è´¥è¿”å›ï¼š</p>

<p><img src="https://user-gold-cdn.xitu.io/2019/11/22/16e928372303774e?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img" /></p>

<h2 id="4ç»§ç»­å®Œå–„">4.ç»§ç»­å®Œå–„</h2>

<p>è‡³æ­¤ï¼Œæˆ‘ä»¬çš„<code class="language-plaintext highlighter-rouge">MyPromise</code>çš„å·²ç»åŸºæœ¬å¯ä»¥è¿è¡Œäº†ï¼Œä½†æ˜¯ç°åœ¨æœ‰ä¸€ä¸ªå¾ˆä¸¥é‡çš„ç¼ºé™·ï¼Œå¦‚æœé‡åˆ°å¼‚æ­¥çš„è¯·æ±‚æ—¶å€™ï¼Œ<code class="language-plaintext highlighter-rouge">resolve</code>ä¸èƒ½æŒ‰ä¸Šä¸‹æ–‡æ‰§è¡Œï¼Œè¿™ä¼šå¯¼è‡´thenæ–¹æ³•æ‰§è¡Œå¤±è´¥ä¾‹å¦‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    var test = new MyPromise((resolve, reject) =&gt; {
        setTimeout(() =&gt; {
            resolve(123);
        }, 2000)
    })
    .then(msg =&gt; {
        console.log(msg);
        return 456;
    })
å¤åˆ¶ä»£ç 
</code></pre></div></div>

<p>å› ä¸ºåœ¨è°ƒç”¨<code class="language-plaintext highlighter-rouge">then</code>æ–¹æ³•çš„æ—¶å€™ï¼Œ<code class="language-plaintext highlighter-rouge">promise</code>çš„çŠ¶æ€è¿˜æ²¡æœ‰æ”¹å˜ï¼Œè€Œæˆ‘ä»¬çš„<code class="language-plaintext highlighter-rouge">then</code>æ–¹æ³•è¿˜æ²¡æœ‰å¤„ç†pendingçŠ¶æ€çš„é€»è¾‘ã€‚ è¿™å¯¼è‡´æ‰§è¡Œå¼‚æ­¥æ–¹æ³•çš„æ—¶å€™ï¼Œthenæ–¹æ³•ä¸ä¼šè¿”å›ä»»ä½•ä¸œè¥¿
 æ¯”å¦‚ï¼Œåœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œjavscriptå·²ç»æŠŠ<code class="language-plaintext highlighter-rouge">then</code>æ–¹æ³•æ‰§è¡Œäº†ï¼Œä½†<code class="language-plaintext highlighter-rouge">setTimeout</code>ä¸­çš„æ–¹æ³•è¿˜åœ¨<code class="language-plaintext highlighter-rouge">eventloop</code>ä¸­ç­‰å¾…æ‰§è¡Œã€‚ è¿™æ ·éœ€è¦åšçš„æ˜¯ï¼š</p>

<ul>
  <li>å°†<code class="language-plaintext highlighter-rouge">then</code>ä¸­çš„æ–¹æ³•ä¿å­˜èµ·æ¥ï¼Œç­‰å¾…<code class="language-plaintext highlighter-rouge">resolve</code>æˆ–<code class="language-plaintext highlighter-rouge">reject</code>æ‰§è¡Œåå†è°ƒç”¨åˆšåˆšä¿å­˜çš„<code class="language-plaintext highlighter-rouge">then</code>ä¸­çš„æ–¹æ³•</li>
  <li>ç”±äºåœ¨è¿™æœŸé—´å¯èƒ½ä¼šæœ‰å¤šä¸ª<code class="language-plaintext highlighter-rouge">then</code>æ–¹æ³•ä¼šè¢«æ‰§è¡Œï¼Œæ‰€ä»¥éœ€è¦ç”¨ä¸€ä¸ªæ•°æ®æ¥ä¿å­˜è¿™äº›æ–¹æ³•
 æ ¹æ®è¿™ä¸¤ç‚¹ï¼Œå†æ¥ä¿®æ”¹ä¸€äº›ä»£ç </li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    // åœ¨constructorä¸­æ–°å¢ä¸¤ä¸ªæ•°ç»„åˆ†åˆ«ç”¨äºè£…thenä¸­çš„resolveå’Œrejectæ–¹æ³•
    constructor(callback) {
        this.resolveArr = [];
        this.rejectArr = [];
    }
    
    // ä¿®æ”¹resolveæ–¹æ³•
    resolve = (value) =&gt; {
        // åˆ¤æ–­çŠ¶æ€æ˜¯å¦éœ€è¦æ˜¯pending
            if (this.state === stateArr[0]) {
               this.state = stateArr[1]; // æ›´æ–°çŠ¶æ€ä¸º fulfilled
               this.value = value; // å†™å…¥æœ€ç»ˆçš„è¿”å›å€¼
               
               this.resolveArr.forEach(fun =&gt; fun(value)) // å¾ªç¯æ‰§è¡Œthenå·²æ’å…¥çš„resolveæ–¹æ³•
            }
    }
    
    // ä¿®æ”¹rejectæ–¹æ³•
    reject = (reason) =&gt; {
        // åˆ¤æ–­çŠ¶æ€æ˜¯å¦éœ€è¦æ˜¯pending
            if (this.state === stateArr[0]) {
               this.state = stateArr[1]; // æ›´æ–°çŠ¶æ€ä¸º fulfilled
               this.reason = reason; // å†™å…¥æœ€ç»ˆçš„è¿”å›å€¼
               
               this.rejectArr.forEach(fun =&gt; fun(reason)) // å¾ªç¯æ‰§è¡Œthenå·²æ’å…¥çš„rejectæ–¹æ³•
            }
    }
    
    // thenæ–¹æ³•ä¸­éœ€è¦æ·»åŠ æ•æ‰pendingçŠ¶æ€çš„é€»è¾‘
    then = (onFulilled, onRejected) =&gt; {
        // å¦‚æœçŠ¶æ€ä¸ºpending
        if (this.state === stateArr[0]) {
            return new Promise((resolve, reject) =&gt; {
                // æ’å…¥æˆåŠŸæ—¶è°ƒç”¨çš„å‡½æ•°
                this.resolveArr.push((value) =&gt; {
                    try {
                        const result = onFulilled(value);
                        if (result instanceof MyPromise) {
                            result.then(resolve, reject);
                        } else {
                            resolve(result);
                        }
                    } catch(err) {
                        reject(err);
                    }
                })
                
                // æ’å…¥å¤±è´¥æ—¶è°ƒç”¨çš„å‡½æ•°
                this.rejectArr.push((value) =&gt; {
                    try {
                        const result = onRejected(value);
                        if (result instanceof MyPromise) {
                            result.then(resolve, reject);
                        } else {
                            resolve(result);
                        }
                    } catch(err) {
                        reject(err)
                    }
                })
            })
        }
    }
å¤åˆ¶ä»£ç 
</code></pre></div></div>

<p>å†™å¥½äº†ï¼Œæµ‹è¯•ä¸€ä¸‹~</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    new MyPromise((resolve, reject) =&gt; {
        setTimeout(() =&gt; {
            resolve(123);
        }, 2000)
    })
    .then(msg =&gt; {
        console.log(msg);
        return new MyPromise((resolve, reject) =&gt; {
			setTimeout(()=&gt; {
				resolve(456)
			}, 2000);
		})
    })
    .then(msg =&gt; {
        console.log(msg);
    })
å¤åˆ¶ä»£ç 
</code></pre></div></div>

<p><img src="https://user-gold-cdn.xitu.io/2019/11/22/16e9305dfe1d1c32?imageslim" alt="img" /></p>

<h2 id="5promiseçš„å…¶ä»–æ–¹æ³•">5.Promiseçš„å…¶ä»–æ–¹æ³•</h2>

<p>æ ¹æ®Promiseè§„èŒƒå®ç°çš„<code class="language-plaintext highlighter-rouge">Promise</code>å¤§è‡´å·²ç»å®Œæˆå•¦ï¼Œæœ€åæˆ‘ä»¬æŠŠPromiseä¸­å®ç°çš„æ–¹æ³•ä¹Ÿè¡¥ä¸€ä¸‹</p>

<ul>
  <li>catchæ–¹æ³•</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    // åœ¨MyPromiseåŸå‹ä¸­å®ç°
    class MyPromise {
        // è°ƒç”¨thenä¸­çš„reject
        catch = (reject) =&gt; {
            this.then(null, reject);
        }
    }
å¤åˆ¶ä»£ç 
</code></pre></div></div>

<ul>
  <li>resolve</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    MyPromise.resolve = (value) =&gt; {
        return new MyPromise((resolve, reject) =&gt; { resolve(value) });
    }
å¤åˆ¶ä»£ç 
</code></pre></div></div>

<ul>
  <li>reject</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    MyPromise.resolve = (reason) =&gt; {
        return new MyPromise((resolve, reject) =&gt; { reject(reason) });
    }
å¤åˆ¶ä»£ç 
</code></pre></div></div>

<ul>
  <li>è¿˜æœ‰<code class="language-plaintext highlighter-rouge">all</code>ï¼Œ<code class="language-plaintext highlighter-rouge">race</code>ï¼Œ<code class="language-plaintext highlighter-rouge">finally(åŸå‹æ–¹æ³•)</code>ï¼Œå…¶å®éƒ½æ˜¯æ ¹æ®<strong>Promiseä¸­çš„åŸå‹</strong>æ–¹æ³•å’Œ<strong>Promiseè§„åˆ™</strong>å®ç°çš„ï¼Œè¿™é‡Œå°±ä¸ä¸€ä¸€åˆ—ä¸¾å•¦ã€‚éœ€è¦äº†è§£çš„å°ä¼™ä¼´å¯ä»¥<a href="https://github.com/then/promise">è‡ªè¡Œå»çœ‹</a></li>
</ul>

<h2 id="æœ€ç»ˆä»£ç æºç åœ°å€">æœ€ç»ˆä»£ç (<a href="https://github.com/IchliebedichZhu/articles/tree/master/promise">æºç åœ°å€</a>)</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const stateArr = ['pending', 'fulfilled', 'rejected']; // ä¸‰ç§çŠ¶æ€
class MyPromise {
    constructor(callback) {
        this.state = stateArr[0]; // å½“å‰çŠ¶æ€
        this.value = null; // å®Œæˆæ—¶çš„è¿”å›å€¼
        this.reason = null; // å¤±è´¥åŸå› 
        this.resolveArr = [];
        this.rejectArr = [];
        
        callback(this.resolve, this.reject); // è°ƒç”¨æ­¤function
    }
    
    // callbackä¸­æ‰§è¡Œçš„resolveæ–¹æ³•
    resolve = (value) =&gt; {
        // åˆ¤æ–­çŠ¶æ€æ˜¯å¦éœ€è¦æ˜¯pending
            if (this.state === stateArr[0]) {
                this.state = stateArr[1]; // æ›´æ–°çŠ¶æ€ä¸º fulfilled
                this.value = value; // å†™å…¥æœ€ç»ˆçš„è¿”å›å€¼
               
                this.resolveArr.forEach(fun =&gt; fun(value)) // å¾ªç¯æ‰§è¡Œthenå·²æ’å…¥çš„resolveæ–¹æ³•
            }
    }
    
    // callbackä¸­æ‰§è¡Œçš„rejectæ–¹æ³•
    reject = (reason) =&gt; {
        // åˆ¤æ–­çŠ¶æ€æ˜¯å¦éœ€è¦æ˜¯pending
            if (this.state === stateArr[0]) {
               this.state = stateArr[1]; // æ›´æ–°çŠ¶æ€ä¸º fulfilled
               this.reason = reason; // å†™å…¥æœ€ç»ˆçš„è¿”å›å€¼
               
               this.rejectArr.forEach(fun =&gt; fun(reason)) // å¾ªç¯æ‰§è¡Œthenå·²æ’å…¥çš„rejectæ–¹æ³•
            }
    }
    
    // thenæ–¹æ³•
    then = (onFulilled, onRejected) =&gt; {
        // åˆ¤æ–­onFulilled å’Œ onRejectedæ˜¯å¦æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå¦‚æœä¸æ˜¯å‡½æ•°åˆ™å¿½ç•¥å®ƒ
        onFulilled = typeof onFulilled === 'function' ? onFulilled : (value) =&gt; value;
        onRejected = typeof onRejected === 'function' ? onRejected : (reason) =&gt; reason;

        // å¦‚æœçŠ¶æ€ä¸ºpending
        if (this.state === stateArr[0]) {
            return new MyPromise((resolve, reject) =&gt; {
                // æ’å…¥æˆåŠŸæ—¶è°ƒç”¨çš„å‡½æ•°
                this.resolveArr.push((value) =&gt; {
                    try {
                        const result = onFulilled(value);
                        if (result instanceof MyPromise) {
                            result.then(resolve, reject);
                        } else {
                            resolve(result);
                        }
                    } catch(err) {
                        reject(err);
                    }
                })
                
                // æ’å…¥å¤±è´¥æ—¶è°ƒç”¨çš„å‡½æ•°
                this.rejectArr.push((value) =&gt; {
                    try {
                        const result = onRejected(value);
                        if (result instanceof MyPromise) {
                            result.then(resolve, reject);
                        } else {
                            resolve(result);
                        }
                    } catch(err) {
                        reject(err)
                    }
                })
            })
            
        }
        
        // å¦‚æœçŠ¶æ€æ˜¯fulfilled
        if (this.state === stateArr[1]) {
            // thenè¿”å›çš„å¿…é¡»æ˜¯ä¸€ä¸ªpromise
            return new MyPromise((resolve, reject) =&gt; {
                try {
                    const result = onFulilled(this.value); // æ‰§è¡Œä¼ å…¥çš„onFulilledæ–¹æ³•
                    
                    // å¦‚æœonFulilledè¿”å›çš„æ˜¯ä¸€ä¸ªPromise,åˆ™è°ƒç”¨thenæ–¹æ³•
                    if (result instanceof MyPromise) {
                        result.then(resolve, reject);
                    } else {
                        resolve(result);
                    }
                } catch(err) {
                    reject(err);
                }
            })
        }
        
        // å¦‚æœçŠ¶æ€æ˜¯rejected
        if (this.state === stateArr[2]) {
            // thenè¿”å›çš„å¿…é¡»æ˜¯ä¸€ä¸ªpromise
            return new MyPromise((resolve, reject) =&gt; {
                try {
                    const result = onRejected(this.reason); // æ‰§è¡Œä¼ å…¥çš„onRejectedæ–¹æ³•
                    
                    // å¦‚æœonRejectedè¿”å›çš„æ˜¯ä¸€ä¸ªPromise,åˆ™è°ƒç”¨thenæ–¹æ³•
                    if (result instanceof MyPromise) {
                        result.then(resolve, reject);
                    } else {
                        resolve(result);
                    }
                } catch(err) {
                    reject(err);
                }
            })
        }
    }

    // è°ƒç”¨thenä¸­çš„reject
    catch = (reject) =&gt; {
        this.then(null, reject);
    }
}

MyPromise.resolve = (value) =&gt; {
    return new MyPromise((resolve, reject) =&gt; { resolve(value) });
}

MyPromise.resolve = (reason) =&gt; {
    return new MyPromise((resolve, reject) =&gt; { reject(reason) });
}

å¤åˆ¶ä»£ç 
</code></pre></div></div>

<h2 id="å°ç»“">å°ç»“</h2>

<p>è¿™æ¬¡æˆ‘ä»¬äº†è§£äº†promiseæ˜¯å¦‚ä½•å®ç°çš„ï¼š</p>

<ul>
  <li>å¿…é¡»æ˜¯æ„é€ å‡½æ•°</li>
  <li>ä¸‰ç§çŠ¶æ€ï¼ˆpendingï¼Œresolveï¼Œrejectï¼‰</li>
  <li>thenæ–¹æ³•ï¼ˆpromiseä¸­å¿…é¡»è¦æœ‰çš„æ–¹æ³•ï¼‰</li>
</ul>

<p>ä»æ„é€ å‡½æ•°å¼€å§‹ï¼Œåˆ°ä¸‰ç§çŠ¶æ€çš„å®ç°ï¼Œæœ€åå®ç°thenæ–¹æ³•ä¸€æ­¥æ­¥æ ¹æ®<code class="language-plaintext highlighter-rouge">Promiseè§„åˆ™</code>æ¥å®ç°Promiseã€‚äº†è§£å®Œä»¥åå°±å¯ä»¥åœ¨é¢è¯•å®˜é¢å‰æ‰‹å†™ä¸€ä¸ªPromiseå•¦ï¼ğŸ˜„</p>

<p>ä½œè€…ï¼šIchmagR
é“¾æ¥ï¼šhttps://juejin.im/post/6844904002946072589
æ¥æºï¼šæ˜é‡‘
è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p>
:ET