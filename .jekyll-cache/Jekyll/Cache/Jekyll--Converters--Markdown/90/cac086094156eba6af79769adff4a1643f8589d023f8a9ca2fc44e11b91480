I"¾8<h1 id="æ·±å…¥å‰–ævueæ ¸å¿ƒä¹‹è™šæ‹Ÿdom"><a href="https://blog.fundebug.com/2017/05/25/arrow-function-for-beginner/"><strong>æ·±å…¥å‰–æï¼šVueæ ¸å¿ƒä¹‹è™šæ‹ŸDOM</strong></a></h1>

<h2 id="å‰è¨€">å‰è¨€</h2>

<p>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">Vue</code> åšé¡¹ç›®ä¹Ÿæœ‰ä¸¤å¹´æ—¶é—´äº†ï¼Œå¯¹ <code class="language-plaintext highlighter-rouge">Vue</code> çš„ <code class="language-plaintext highlighter-rouge">api</code>ä¹Ÿç”¨çš„æ¯”è¾ƒå¾—å¿ƒåº”æ‰‹äº†ï¼Œè™½ç„¶å¯¹ <code class="language-plaintext highlighter-rouge">Vue</code> çš„ä¸€äº›å®ç°åŸç†ä¹Ÿè€³æœ‰æ‰€é—»ï¼Œä¾‹å¦‚ è™šæ‹Ÿ<code class="language-plaintext highlighter-rouge">DOM</code>ã€<code class="language-plaintext highlighter-rouge">flow</code>ã€æ•°æ®é©±åŠ¨ã€è·¯ç”±åŸç†ç­‰ç­‰ï¼Œä½†æ˜¯è‡ªå·±å¹¶æ²¡æœ‰ç‰¹æ„å»æ¢ç©¶è¿™äº›åŸç†çš„åŸºç¡€ä»¥åŠ <code class="language-plaintext highlighter-rouge">Vue</code> æºç æ˜¯å¦‚ä½•åˆ©ç”¨è¿™äº›åŸç†è¿›è¡Œæ¡†æ¶å®ç°çš„ï¼Œæ‰€ä»¥åˆ©ç”¨ç©ºé—²æ—¶é—´ï¼Œè¿›è¡Œ <code class="language-plaintext highlighter-rouge">Vue</code> æ¡†æ¶ç›¸å…³æŠ€æœ¯åŸç†å’Œ <code class="language-plaintext highlighter-rouge">Vue</code> æ¡†æ¶çš„å…·ä½“å®ç°çš„æ•´ç†ã€‚å¦‚æœä½ å¯¹ <code class="language-plaintext highlighter-rouge">Vue</code> çš„å®ç°åŸç†å¾ˆæ„Ÿå…´è¶£ï¼Œé‚£ä¹ˆå°±å¯ä»¥å¼€å§‹è¿™ç³»åˆ—æ–‡ç« çš„é˜…è¯»ï¼Œå°†ä¼šä¸ºä½ æ‰“å¼€ <code class="language-plaintext highlighter-rouge">Vue</code> çš„åº•å±‚ä¸–ç•Œå¤§é—¨ï¼Œå¯¹å®ƒçš„å®ç°ç»†èŠ‚ä¸€æ¢ç©¶ç«Ÿã€‚ æœ¬æ–‡ä¸º <code class="language-plaintext highlighter-rouge">Virtual DOM</code>çš„æŠ€æœ¯åŸç†å’Œ <code class="language-plaintext highlighter-rouge">Vue</code> æ¡†æ¶çš„å…·ä½“å®ç°ã€‚</p>

<p><strong>è¾›è‹¦ç¼–å†™è‰¯ä¹…ï¼Œè¿˜æœ›æ‰‹åŠ¨ç‚¹èµé¼“åŠ±~</strong></p>

<p><strong>githubåœ°å€ä¸ºï¼š<a href="https://github.com/fengshi123/blog">github.com/fengshi123/â€¦</a>ï¼Œä¸Šé¢æ±‡æ€»äº†ä½œè€…æ‰€æœ‰çš„åšå®¢æ–‡ç« ï¼Œå¦‚æœå–œæ¬¢æˆ–è€…æœ‰æ‰€å¯å‘ï¼Œè¯·å¸®å¿™ç»™ä¸ª star ~ï¼Œå¯¹ä½œè€…ä¹Ÿæ˜¯ä¸€ç§é¼“åŠ±ã€‚</strong></p>

<h2 id="ä¸€çœŸå®domå’Œå…¶è§£ææµç¨‹">ä¸€ã€çœŸå®<code class="language-plaintext highlighter-rouge">DOM</code>å’Œå…¶è§£ææµç¨‹</h2>

<p>â€‹	æœ¬èŠ‚æˆ‘ä»¬ä¸»è¦ä»‹ç»çœŸå®   <code class="language-plaintext highlighter-rouge">DOM</code> çš„è§£æè¿‡ç¨‹ï¼Œé€šè¿‡ä»‹ç»å…¶è§£æè¿‡ç¨‹ä»¥åŠå­˜åœ¨çš„é—®é¢˜ï¼Œä»è€Œå¼•å‡ºä¸ºä»€ä¹ˆéœ€è¦è™šæ‹Ÿ<code class="language-plaintext highlighter-rouge">DOM</code>ã€‚ä¸€å›¾èƒœåƒè¨€ï¼Œå¦‚ä¸‹å›¾ä¸º <code class="language-plaintext highlighter-rouge">webkit</code> æ¸²æŸ“å¼•æ“å·¥ä½œæµç¨‹å›¾</p>

<p><img src="https://user-gold-cdn.xitu.io/2019/7/23/16c1e10922325215?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img" /></p>

<p>â€‹	æ‰€æœ‰çš„æµè§ˆå™¨æ¸²æŸ“å¼•æ“å·¥ä½œæµç¨‹å¤§è‡´åˆ†ä¸º5æ­¥ï¼šåˆ›å»º        <code class="language-plaintext highlighter-rouge">DOM</code> æ ‘ â€”&gt; åˆ›å»º <code class="language-plaintext highlighter-rouge">Style Rules</code> -&gt; æ„å»º <code class="language-plaintext highlighter-rouge">Render</code> æ ‘ â€”&gt; å¸ƒå±€ <code class="language-plaintext highlighter-rouge">Layout</code> -â€”&gt; ç»˜åˆ¶ <code class="language-plaintext highlighter-rouge">Painting</code>ã€‚</p>

<ul>
  <li>ç¬¬ä¸€æ­¥ï¼Œæ„å»º DOM æ ‘ï¼šç”¨ HTML åˆ†æå™¨ï¼Œåˆ†æ HTML å…ƒç´ ï¼Œæ„å»ºä¸€æ£µ DOM æ ‘ï¼›</li>
  <li>ç¬¬äºŒæ­¥ï¼Œç”Ÿæˆæ ·å¼è¡¨ï¼šç”¨ CSS åˆ†æå™¨ï¼Œåˆ†æ CSS æ–‡ä»¶å’Œå…ƒç´ ä¸Šçš„ inline æ ·å¼ï¼Œç”Ÿæˆé¡µé¢çš„æ ·å¼è¡¨ï¼›</li>
  <li>ç¬¬ä¸‰æ­¥ï¼Œæ„å»º Render æ ‘ï¼šå°† DOM æ ‘å’Œæ ·å¼è¡¨å…³è”èµ·æ¥ï¼Œæ„å»ºä¸€æ£µ Render æ ‘ï¼ˆAttachmentï¼‰ã€‚æ¯ä¸ª DOM èŠ‚ç‚¹éƒ½æœ‰ attach æ–¹æ³•ï¼Œæ¥å—æ ·å¼ä¿¡æ¯ï¼Œè¿”å›ä¸€ä¸ª render å¯¹è±¡ï¼ˆåˆå rendererï¼‰ï¼Œè¿™äº› render å¯¹è±¡æœ€ç»ˆä¼šè¢«æ„å»ºæˆä¸€æ£µ Render æ ‘ï¼›</li>
  <li>ç¬¬å››æ­¥ï¼Œç¡®å®šèŠ‚ç‚¹åæ ‡ï¼šæ ¹æ® Render æ ‘ç»“æ„ï¼Œä¸ºæ¯ä¸ª Render æ ‘ä¸Šçš„èŠ‚ç‚¹ç¡®å®šä¸€ä¸ªåœ¨æ˜¾ç¤ºå±ä¸Šå‡ºç°çš„ç²¾ç¡®åæ ‡ï¼›</li>
  <li>ç¬¬äº”æ­¥ï¼Œç»˜åˆ¶é¡µé¢ï¼šæ ¹æ® Render æ ‘å’ŒèŠ‚ç‚¹æ˜¾ç¤ºåæ ‡ï¼Œç„¶åè°ƒç”¨æ¯ä¸ªèŠ‚ç‚¹çš„ paint æ–¹æ³•ï¼Œå°†å®ƒä»¬ç»˜åˆ¶å‡ºæ¥ã€‚</li>
</ul>

<p><strong>æ³¨æ„ç‚¹ï¼š</strong></p>

<p><strong>1ã€<code class="language-plaintext highlighter-rouge">DOM</code> æ ‘çš„æ„å»ºæ˜¯æ–‡æ¡£åŠ è½½å®Œæˆå¼€å§‹çš„ï¼Ÿ</strong> æ„å»º <code class="language-plaintext highlighter-rouge">DOM</code> æ ‘æ˜¯ä¸€ä¸ªæ¸è¿›è¿‡ç¨‹ï¼Œä¸ºè¾¾åˆ°æ›´å¥½çš„ç”¨æˆ·ä½“éªŒï¼Œæ¸²æŸ“å¼•æ“ä¼šå°½å¿«å°†å†…å®¹æ˜¾ç¤ºåœ¨å±å¹•ä¸Šï¼Œå®ƒä¸å¿…ç­‰åˆ°æ•´ä¸ª <code class="language-plaintext highlighter-rouge">HTML</code> æ–‡æ¡£è§£æå®Œæˆä¹‹åæ‰å¼€å§‹æ„å»º <code class="language-plaintext highlighter-rouge">render</code> æ ‘å’Œå¸ƒå±€ã€‚</p>

<p><strong>2ã€<code class="language-plaintext highlighter-rouge">Render</code> æ ‘æ˜¯ <code class="language-plaintext highlighter-rouge">DOM</code> æ ‘å’Œ <code class="language-plaintext highlighter-rouge">CSS</code> æ ·å¼è¡¨æ„å»ºå®Œæ¯•åæ‰å¼€å§‹æ„å»ºçš„ï¼Ÿ</strong> è¿™ä¸‰ä¸ªè¿‡ç¨‹åœ¨å®é™…è¿›è¡Œçš„æ—¶å€™å¹¶ä¸æ˜¯å®Œå…¨ç‹¬ç«‹çš„ï¼Œè€Œæ˜¯ä¼šæœ‰äº¤å‰ï¼Œä¼šä¸€è¾¹åŠ è½½ï¼Œä¸€è¾¹è§£æï¼Œä»¥åŠä¸€è¾¹æ¸²æŸ“ã€‚</p>

<p><strong>3ã€<code class="language-plaintext highlighter-rouge">CSS</code> çš„è§£ææ³¨æ„ç‚¹ï¼Ÿ</strong> <code class="language-plaintext highlighter-rouge">CSS</code> çš„è§£ææ˜¯ä»å³å¾€å·¦é€†å‘è§£æçš„ï¼ŒåµŒå¥—æ ‡ç­¾è¶Šå¤šï¼Œè§£æè¶Šæ…¢ã€‚</p>

<p><strong>4ã€<code class="language-plaintext highlighter-rouge">JS</code> æ“ä½œçœŸå® <code class="language-plaintext highlighter-rouge">DOM</code> çš„ä»£ä»·ï¼Ÿ</strong> ç”¨æˆ‘ä»¬ä¼ ç»Ÿçš„å¼€å‘æ¨¡å¼ï¼ŒåŸç”Ÿ <code class="language-plaintext highlighter-rouge">JS</code> æˆ– <code class="language-plaintext highlighter-rouge">JQ</code> æ“ä½œ <code class="language-plaintext highlighter-rouge">DOM</code> æ—¶ï¼Œæµè§ˆå™¨ä¼šä»æ„å»º DOM æ ‘å¼€å§‹ä»å¤´åˆ°å°¾æ‰§è¡Œä¸€éæµç¨‹ã€‚åœ¨ä¸€æ¬¡æ“ä½œä¸­ï¼Œæˆ‘éœ€è¦æ›´æ–° 10 ä¸ª <code class="language-plaintext highlighter-rouge">DOM</code> èŠ‚ç‚¹ï¼Œæµè§ˆå™¨æ”¶åˆ°ç¬¬ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">DOM</code> è¯·æ±‚åå¹¶ä¸çŸ¥é“è¿˜æœ‰ 9 æ¬¡æ›´æ–°æ“ä½œï¼Œå› æ­¤ä¼šé©¬ä¸Šæ‰§è¡Œæµç¨‹ï¼Œæœ€ç»ˆæ‰§è¡Œ10 æ¬¡ã€‚ä¾‹å¦‚ï¼Œç¬¬ä¸€æ¬¡è®¡ç®—å®Œï¼Œç´§æ¥ç€ä¸‹ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">DOM</code> æ›´æ–°è¯·æ±‚ï¼Œè¿™ä¸ªèŠ‚ç‚¹çš„åæ ‡å€¼å°±å˜äº†ï¼Œå‰ä¸€æ¬¡è®¡ç®—ä¸ºæ— ç”¨åŠŸã€‚è®¡ç®— <code class="language-plaintext highlighter-rouge">DOM</code> èŠ‚ç‚¹åæ ‡å€¼ç­‰éƒ½æ˜¯ç™½ç™½æµªè´¹çš„æ€§èƒ½ã€‚å³ä½¿è®¡ç®—æœºç¡¬ä»¶ä¸€ç›´åœ¨è¿­ä»£æ›´æ–°ï¼Œæ“ä½œ <code class="language-plaintext highlighter-rouge">DOM</code> çš„ä»£ä»·ä»æ—§æ˜¯æ˜‚è´µçš„ï¼Œé¢‘ç¹æ“ä½œè¿˜æ˜¯ä¼šå‡ºç°é¡µé¢å¡é¡¿ï¼Œå½±å“ç”¨æˆ·ä½“éªŒ</p>

<h2 id="äºŒvirtual-dom-åŸºç¡€">äºŒã€<code class="language-plaintext highlighter-rouge">Virtual-DOM</code> åŸºç¡€</h2>

<h3 id="21è™šæ‹Ÿ-dom-çš„å¥½å¤„">2.1ã€è™šæ‹Ÿ <code class="language-plaintext highlighter-rouge">DOM</code> çš„å¥½å¤„</h3>

<p>â€‹	è™šæ‹Ÿ <code class="language-plaintext highlighter-rouge">DOM</code> å°±æ˜¯ä¸ºäº†è§£å†³æµè§ˆå™¨æ€§èƒ½é—®é¢˜è€Œè¢«è®¾è®¡å‡ºæ¥çš„ã€‚å¦‚å‰ï¼Œè‹¥ä¸€æ¬¡æ“ä½œä¸­æœ‰ 10 æ¬¡æ›´æ–° <code class="language-plaintext highlighter-rouge">DOM</code> çš„åŠ¨ä½œï¼Œè™šæ‹Ÿ <code class="language-plaintext highlighter-rouge">DOM</code> ä¸ä¼šç«‹å³æ“ä½œ <code class="language-plaintext highlighter-rouge">DOM</code>ï¼Œè€Œæ˜¯å°†è¿™ 10 æ¬¡æ›´æ–°çš„ <code class="language-plaintext highlighter-rouge">diff</code> å†…å®¹ä¿å­˜åˆ°æœ¬åœ°ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">JS</code> å¯¹è±¡ä¸­ï¼Œæœ€ç»ˆå°†è¿™ä¸ª <code class="language-plaintext highlighter-rouge">JS</code> å¯¹è±¡ä¸€æ¬¡æ€§ <code class="language-plaintext highlighter-rouge">attch</code> åˆ° <code class="language-plaintext highlighter-rouge">DOM</code> æ ‘ä¸Šï¼Œå†è¿›è¡Œåç»­æ“ä½œï¼Œé¿å…å¤§é‡æ— è°“çš„è®¡ç®—é‡ã€‚æ‰€ä»¥ï¼Œç”¨ <code class="language-plaintext highlighter-rouge">JS</code> å¯¹è±¡æ¨¡æ‹Ÿ <code class="language-plaintext highlighter-rouge">DOM</code> èŠ‚ç‚¹çš„å¥½å¤„æ˜¯ï¼Œé¡µé¢çš„æ›´æ–°å¯ä»¥å…ˆå…¨éƒ¨åæ˜ åœ¨ <code class="language-plaintext highlighter-rouge">JS</code> å¯¹è±¡(è™šæ‹Ÿ <code class="language-plaintext highlighter-rouge">DOM</code> )ä¸Šï¼Œæ“ä½œå†…å­˜ä¸­çš„ <code class="language-plaintext highlighter-rouge">JS</code> å¯¹è±¡çš„é€Ÿåº¦æ˜¾ç„¶è¦æ›´å¿«ï¼Œç­‰æ›´æ–°å®Œæˆåï¼Œå†å°†æœ€ç»ˆçš„ <code class="language-plaintext highlighter-rouge">JS</code> å¯¹è±¡æ˜ å°„æˆçœŸå®çš„ <code class="language-plaintext highlighter-rouge">DOM</code>ï¼Œäº¤ç”±æµè§ˆå™¨å»ç»˜åˆ¶ã€‚</p>

<h3 id="22ç®—æ³•å®ç°">2.2ã€ç®—æ³•å®ç°</h3>

<h4 id="221ç”¨-js-å¯¹è±¡æ¨¡æ‹Ÿ-dom-æ ‘">2.2.1ã€ç”¨ <code class="language-plaintext highlighter-rouge">JS</code> å¯¹è±¡æ¨¡æ‹Ÿ <code class="language-plaintext highlighter-rouge">DOM</code> æ ‘</h4>

<p><strong>ï¼ˆ1ï¼‰å¦‚ä½•ç”¨ <code class="language-plaintext highlighter-rouge">JS</code> å¯¹è±¡æ¨¡æ‹Ÿ <code class="language-plaintext highlighter-rouge">DOM</code> æ ‘</strong></p>

<p>ä¾‹å¦‚ä¸€ä¸ªçœŸå®çš„ <code class="language-plaintext highlighter-rouge">DOM</code> èŠ‚ç‚¹å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;div id="virtual-dom"&gt;
&lt;p&gt;Virtual DOM&lt;/p&gt;
&lt;ul id="list"&gt;
  &lt;li class="item"&gt;Item 1&lt;/li&gt;
  &lt;li class="item"&gt;Item 2&lt;/li&gt;
  &lt;li class="item"&gt;Item 3&lt;/li&gt;
&lt;/ul&gt;
&lt;div&gt;Hello World&lt;/div&gt;
&lt;/div&gt; 
å¤åˆ¶ä»£ç 
</code></pre></div></div>

<p>æˆ‘ä»¬ç”¨ <code class="language-plaintext highlighter-rouge">JavaScript</code> å¯¹è±¡æ¥è¡¨ç¤º <code class="language-plaintext highlighter-rouge">DOM</code> èŠ‚ç‚¹ï¼Œä½¿ç”¨å¯¹è±¡çš„å±æ€§è®°å½•èŠ‚ç‚¹çš„ç±»å‹ã€å±æ€§ã€å­èŠ‚ç‚¹ç­‰ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">element.js</code> ä¸­è¡¨ç¤ºèŠ‚ç‚¹å¯¹è±¡ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/**
 * Element virdual-dom å¯¹è±¡å®šä¹‰
 * @param {String} tagName - dom å…ƒç´ åç§°
 * @param {Object} props - dom å±æ€§
 * @param {Array&lt;Element|String&gt;} - å­èŠ‚ç‚¹
 */
function Element(tagName, props, children) {
    this.tagName = tagName
    this.props = props
    this.children = children
    // dom å…ƒç´ çš„ key å€¼ï¼Œç”¨ä½œå”¯ä¸€æ ‡è¯†ç¬¦
    if(props.key){
       this.key = props.key
    }
    var count = 0
    children.forEach(function (child, i) {
        if (child instanceof Element) {
            count += child.count
        } else {
            children[i] = '' + child
        }
        count++
    })
    // å­å…ƒç´ ä¸ªæ•°
    this.count = count
}

function createElement(tagName, props, children){
 return new Element(tagName, props, children);
}

module.exports = createElement;
å¤åˆ¶ä»£ç 
</code></pre></div></div>

<p>æ ¹æ® <code class="language-plaintext highlighter-rouge">element</code> å¯¹è±¡çš„è®¾å®šï¼Œåˆ™ä¸Šé¢çš„ <code class="language-plaintext highlighter-rouge">DOM</code> ç»“æ„å°±å¯ä»¥ç®€å•è¡¨ç¤ºä¸ºï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var el = require("./element.js");
var ul = el('div',{id:'virtual-dom'},[
  el('p',{},['Virtual DOM']),
  el('ul', { id: 'list' }, [
	el('li', { class: 'item' }, ['Item 1']),
	el('li', { class: 'item' }, ['Item 2']),
	el('li', { class: 'item' }, ['Item 3'])
  ]),
  el('div',{},['Hello World'])
]) 
å¤åˆ¶ä»£ç 
</code></pre></div></div>

<p>ç°åœ¨ <code class="language-plaintext highlighter-rouge">ul</code> å°±æ˜¯æˆ‘ä»¬ç”¨  <code class="language-plaintext highlighter-rouge">JavaScript</code> å¯¹è±¡è¡¨ç¤ºçš„ <code class="language-plaintext highlighter-rouge">DOM</code> ç»“æ„ï¼Œæˆ‘ä»¬è¾“å‡ºæŸ¥çœ‹ <code class="language-plaintext highlighter-rouge">ul</code> å¯¹åº”çš„æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š</p>

<p><img src="https://user-gold-cdn.xitu.io/2019/7/23/16c1e14fcff074f0?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img" /></p>

<p><strong>ï¼ˆ2ï¼‰æ¸²æŸ“ç”¨ <code class="language-plaintext highlighter-rouge">JS</code> è¡¨ç¤ºçš„ <code class="language-plaintext highlighter-rouge">DOM</code> å¯¹è±¡</strong></p>

<p>ä½†æ˜¯é¡µé¢ä¸Šå¹¶æ²¡æœ‰è¿™ä¸ªç»“æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘ä»¬ä»‹ç»å¦‚ä½•å°† <code class="language-plaintext highlighter-rouge">ul</code> æ¸²æŸ“æˆé¡µé¢ä¸ŠçœŸå®çš„ <code class="language-plaintext highlighter-rouge">DOM</code> ç»“æ„ï¼Œç›¸å…³æ¸²æŸ“å‡½æ•°å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/**
 * render å°†virdual-dom å¯¹è±¡æ¸²æŸ“ä¸ºå®é™… DOM å…ƒç´ 
 */
Element.prototype.render = function () {
    var el = document.createElement(this.tagName)
    var props = this.props
    // è®¾ç½®èŠ‚ç‚¹çš„DOMå±æ€§
    for (var propName in props) {
        var propValue = props[propName]
        el.setAttribute(propName, propValue)
    }

    var children = this.children || []
    children.forEach(function (child) {
        var childEl = (child instanceof Element)
            ? child.render() // å¦‚æœå­èŠ‚ç‚¹ä¹Ÿæ˜¯è™šæ‹ŸDOMï¼Œé€’å½’æ„å»ºDOMèŠ‚ç‚¹
            : document.createTextNode(child) // å¦‚æœå­—ç¬¦ä¸²ï¼Œåªæ„å»ºæ–‡æœ¬èŠ‚ç‚¹
        el.appendChild(childEl)
    })
    return el
} 
å¤åˆ¶ä»£ç 
</code></pre></div></div>

<p>æˆ‘ä»¬é€šè¿‡æŸ¥çœ‹ä»¥ä¸Š <code class="language-plaintext highlighter-rouge">render</code> æ–¹æ³•ï¼Œä¼šæ ¹æ®  <code class="language-plaintext highlighter-rouge">tagName</code> æ„å»ºä¸€ä¸ªçœŸæ­£çš„ <code class="language-plaintext highlighter-rouge">DOM</code> èŠ‚ç‚¹ï¼Œç„¶åè®¾ç½®è¿™ä¸ªèŠ‚ç‚¹çš„å±æ€§ï¼Œæœ€åé€’å½’åœ°æŠŠè‡ªå·±çš„å­èŠ‚ç‚¹ä¹Ÿæ„å»ºèµ·æ¥ã€‚</p>

<p>æˆ‘ä»¬å°†æ„å»ºå¥½çš„ <code class="language-plaintext highlighter-rouge">DOM</code> ç»“æ„æ·»åŠ åˆ°é¡µé¢ <code class="language-plaintext highlighter-rouge">body</code> ä¸Šé¢ï¼Œå¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ulRoot = ul.render();
document.body.appendChild(ulRoot); 
å¤åˆ¶ä»£ç 
</code></pre></div></div>

<p>è¿™æ ·ï¼Œé¡µé¢ <code class="language-plaintext highlighter-rouge">body</code> é‡Œé¢å°±æœ‰çœŸæ­£çš„ <code class="language-plaintext highlighter-rouge">DOM</code> ç»“æ„ï¼Œæ•ˆæœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>

<p><img src="https://user-gold-cdn.xitu.io/2019/7/23/16c1e179a748d425?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img" /></p>

<h4 id="222æ¯”è¾ƒä¸¤æ£µè™šæ‹Ÿ-dom-æ ‘çš„å·®å¼‚--diff-ç®—æ³•">2.2.2ã€æ¯”è¾ƒä¸¤æ£µè™šæ‹Ÿ <code class="language-plaintext highlighter-rouge">DOM</code> æ ‘çš„å·®å¼‚ â€” <code class="language-plaintext highlighter-rouge">diff</code> ç®—æ³•</h4>

<p><code class="language-plaintext highlighter-rouge">diff</code> ç®—æ³•ç”¨æ¥æ¯”è¾ƒä¸¤æ£µ <code class="language-plaintext highlighter-rouge">Virtual DOM</code> æ ‘çš„å·®å¼‚ï¼Œå¦‚æœéœ€è¦ä¸¤æ£µæ ‘çš„å®Œå…¨æ¯”è¾ƒï¼Œé‚£ä¹ˆ <code class="language-plaintext highlighter-rouge">diff</code> ç®—æ³•çš„æ—¶é—´å¤æ‚åº¦ä¸º<code class="language-plaintext highlighter-rouge">O(n^3)</code>ã€‚ä½†æ˜¯åœ¨å‰ç«¯å½“ä¸­ï¼Œä½ å¾ˆå°‘ä¼šè·¨è¶Šå±‚çº§åœ°ç§»åŠ¨ <code class="language-plaintext highlighter-rouge">DOM</code> å…ƒç´ ï¼Œæ‰€ä»¥ <code class="language-plaintext highlighter-rouge">Virtual DOM</code> åªä¼šå¯¹åŒä¸€ä¸ªå±‚çº§çš„å…ƒç´ è¿›è¡Œå¯¹æ¯”ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œ <code class="language-plaintext highlighter-rouge">div</code> åªä¼šå’ŒåŒä¸€å±‚çº§çš„ <code class="language-plaintext highlighter-rouge">div</code> å¯¹æ¯”ï¼Œç¬¬äºŒå±‚çº§çš„åªä¼šè·Ÿç¬¬äºŒå±‚çº§å¯¹æ¯”ï¼Œè¿™æ ·ç®—æ³•å¤æ‚åº¦å°±å¯ä»¥è¾¾åˆ° <code class="language-plaintext highlighter-rouge">O(n)</code>ã€‚</p>

<p><img src="https://user-gold-cdn.xitu.io/2019/7/23/16c1e26a5ecf086e?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img" /></p>

<p><strong>ï¼ˆ1ï¼‰æ·±åº¦ä¼˜å…ˆéå†ï¼Œè®°å½•å·®å¼‚</strong></p>

<p>åœ¨å®é™…çš„ä»£ç ä¸­ï¼Œä¼šå¯¹æ–°æ—§ä¸¤æ£µæ ‘è¿›è¡Œä¸€ä¸ªæ·±åº¦ä¼˜å…ˆçš„éå†ï¼Œè¿™æ ·æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šæœ‰ä¸€ä¸ªå”¯ä¸€çš„æ ‡è®°ï¼š</p>

<p><img src="https://user-gold-cdn.xitu.io/2019/7/23/16c1e0e2873e42b1?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="dfs-walk" /></p>

<p>åœ¨æ·±åº¦ä¼˜å…ˆéå†çš„æ—¶å€™ï¼Œæ¯éå†åˆ°ä¸€ä¸ªèŠ‚ç‚¹å°±æŠŠè¯¥èŠ‚ç‚¹å’Œæ–°çš„çš„æ ‘è¿›è¡Œå¯¹æ¯”ã€‚å¦‚æœæœ‰å·®å¼‚çš„è¯å°±è®°å½•åˆ°ä¸€ä¸ªå¯¹è±¡é‡Œé¢ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// diff å‡½æ•°ï¼Œå¯¹æ¯”ä¸¤æ£µæ ‘
function diff(oldTree, newTree) {
  var index = 0 // å½“å‰èŠ‚ç‚¹çš„æ ‡å¿—
  var patches = {} // ç”¨æ¥è®°å½•æ¯ä¸ªèŠ‚ç‚¹å·®å¼‚çš„å¯¹è±¡
  dfsWalk(oldTree, newTree, index, patches)
  return patches
}

// å¯¹ä¸¤æ£µæ ‘è¿›è¡Œæ·±åº¦ä¼˜å…ˆéå†
function dfsWalk(oldNode, newNode, index, patches) {
  var currentPatch = []
  if (typeof (oldNode) === "string" &amp;&amp; typeof (newNode) === "string") {
    // æ–‡æœ¬å†…å®¹æ”¹å˜
    if (newNode !== oldNode) {
      currentPatch.push({ type: patch.TEXT, content: newNode })
    }
  } else if (newNode!=null &amp;&amp; oldNode.tagName === newNode.tagName &amp;&amp; oldNode.key === newNode.key) {
    // èŠ‚ç‚¹ç›¸åŒï¼Œæ¯”è¾ƒå±æ€§
    var propsPatches = diffProps(oldNode, newNode)
    if (propsPatches) {
      currentPatch.push({ type: patch.PROPS, props: propsPatches })
    }
    // æ¯”è¾ƒå­èŠ‚ç‚¹ï¼Œå¦‚æœå­èŠ‚ç‚¹æœ‰'ignore'å±æ€§ï¼Œåˆ™ä¸éœ€è¦æ¯”è¾ƒ
    if (!isIgnoreChildren(newNode)) {
      diffChildren(
        oldNode.children,
        newNode.children,
        index,
        patches,
        currentPatch
      )
    }
  } else if(newNode !== null){
    // æ–°èŠ‚ç‚¹å’Œæ—§èŠ‚ç‚¹ä¸åŒï¼Œç”¨ replace æ›¿æ¢
    currentPatch.push({ type: patch.REPLACE, node: newNode })
  }

  if (currentPatch.length) {
    patches[index] = currentPatch
  }
} 
å¤åˆ¶ä»£ç 
</code></pre></div></div>

<p>ä»ä»¥ä¸Šå¯ä»¥å¾—å‡ºï¼Œ<code class="language-plaintext highlighter-rouge">patches[1]</code> è¡¨ç¤º <code class="language-plaintext highlighter-rouge">p</code> ï¼Œ<code class="language-plaintext highlighter-rouge">patches[3]</code> è¡¨ç¤º <code class="language-plaintext highlighter-rouge">ul</code> ï¼Œä»¥æ­¤ç±»æ¨ã€‚</p>

<p><strong>ï¼ˆ2ï¼‰å·®å¼‚ç±»å‹</strong></p>

<p><code class="language-plaintext highlighter-rouge">DOM</code> æ“ä½œå¯¼è‡´çš„å·®å¼‚ç±»å‹åŒ…æ‹¬ä»¥ä¸‹å‡ ç§ï¼š</p>

<ul>
  <li>èŠ‚ç‚¹æ›¿æ¢ï¼šèŠ‚ç‚¹æ”¹å˜äº†ï¼Œä¾‹å¦‚å°†ä¸Šé¢çš„ <code class="language-plaintext highlighter-rouge">div</code> æ¢æˆ <code class="language-plaintext highlighter-rouge">h1</code>;</li>
  <li>é¡ºåºäº’æ¢ï¼šç§»åŠ¨ã€åˆ é™¤ã€æ–°å¢å­èŠ‚ç‚¹ï¼Œä¾‹å¦‚ä¸Šé¢ <code class="language-plaintext highlighter-rouge">div</code> çš„å­èŠ‚ç‚¹ï¼ŒæŠŠ <code class="language-plaintext highlighter-rouge">p</code> å’Œ <code class="language-plaintext highlighter-rouge">ul</code> é¡ºåºäº’æ¢ï¼›</li>
  <li>å±æ€§æ›´æ”¹ï¼šä¿®æ”¹äº†èŠ‚ç‚¹çš„å±æ€§ï¼Œä¾‹å¦‚æŠŠä¸Šé¢ <code class="language-plaintext highlighter-rouge">li</code> çš„ <code class="language-plaintext highlighter-rouge">class</code> æ ·å¼ç±»åˆ é™¤ï¼›</li>
  <li>æ–‡æœ¬æ”¹å˜ï¼šæ”¹å˜æ–‡æœ¬èŠ‚ç‚¹çš„æ–‡æœ¬å†…å®¹ï¼Œä¾‹å¦‚å°†ä¸Šé¢ <code class="language-plaintext highlighter-rouge">p</code> èŠ‚ç‚¹çš„æ–‡æœ¬å†…å®¹æ›´æ”¹ä¸º â€œ<code class="language-plaintext highlighter-rouge">Real Dom</code>â€ï¼›</li>
</ul>

<p>ä»¥ä¸Šæè¿°çš„å‡ ç§å·®å¼‚ç±»å‹åœ¨ä»£ç ä¸­å®šä¹‰å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var REPLACE = 0 // æ›¿æ¢åŸå…ˆçš„èŠ‚ç‚¹
var REORDER = 1 // é‡æ–°æ’åº
var PROPS = 2 // ä¿®æ”¹äº†èŠ‚ç‚¹çš„å±æ€§
var TEXT = 3 // æ–‡æœ¬å†…å®¹æ”¹å˜ 
å¤åˆ¶ä»£ç 
</code></pre></div></div>

<p><strong>ï¼ˆ3ï¼‰åˆ—è¡¨å¯¹æ¯”ç®—æ³•</strong></p>

<p>â€‹	å­èŠ‚ç‚¹çš„å¯¹æ¯”ç®—æ³•ï¼Œä¾‹å¦‚      <code class="language-plaintext highlighter-rouge">p, ul, div</code> çš„é¡ºåºæ¢æˆäº† <code class="language-plaintext highlighter-rouge">div, p, ul</code>ã€‚è¿™ä¸ªè¯¥æ€ä¹ˆå¯¹æ¯”ï¼Ÿå¦‚æœæŒ‰ç…§åŒå±‚çº§è¿›è¡Œé¡ºåºå¯¹æ¯”çš„è¯ï¼Œå®ƒä»¬éƒ½ä¼šè¢«æ›¿æ¢æ‰ã€‚å¦‚ <code class="language-plaintext highlighter-rouge">p</code> å’Œ <code class="language-plaintext highlighter-rouge">div</code> çš„ <code class="language-plaintext highlighter-rouge">tagName</code> ä¸åŒï¼Œ<code class="language-plaintext highlighter-rouge">p</code> ä¼šè¢« <code class="language-plaintext highlighter-rouge">div</code> æ‰€æ›¿ä»£ã€‚æœ€ç»ˆï¼Œä¸‰ä¸ªèŠ‚ç‚¹éƒ½ä¼šè¢«æ›¿æ¢ï¼Œè¿™æ · <code class="language-plaintext highlighter-rouge">DOM</code> å¼€é”€å°±éå¸¸å¤§ã€‚è€Œå®é™…ä¸Šæ˜¯ä¸éœ€è¦æ›¿æ¢èŠ‚ç‚¹ï¼Œè€Œåªéœ€è¦ç»è¿‡èŠ‚ç‚¹ç§»åŠ¨å°±å¯ä»¥è¾¾åˆ°ï¼Œæˆ‘ä»¬åªéœ€çŸ¥é“æ€ä¹ˆè¿›è¡Œç§»åŠ¨ã€‚</p>

<p>â€‹	å°†è¿™ä¸ªé—®é¢˜æŠ½è±¡å‡ºæ¥å…¶å®å°±æ˜¯å­—ç¬¦ä¸²çš„æœ€å°ç¼–è¾‘è·ç¦»é—®é¢˜ï¼ˆ<code class="language-plaintext highlighter-rouge">Edition Distance</code>ï¼‰ï¼Œæœ€å¸¸è§çš„è§£å†³æ–¹æ³•æ˜¯ <code class="language-plaintext highlighter-rouge">Levenshtein Distance</code> , <code class="language-plaintext highlighter-rouge">Levenshtein Distance</code> æ˜¯ä¸€ä¸ªåº¦é‡ä¸¤ä¸ªå­—ç¬¦åºåˆ—ä¹‹é—´å·®å¼‚çš„å­—ç¬¦ä¸²åº¦é‡æ ‡å‡†ï¼Œä¸¤ä¸ªå•è¯ä¹‹é—´çš„ <code class="language-plaintext highlighter-rouge">Levenshtein Distance</code> æ˜¯å°†ä¸€ä¸ªå•è¯è½¬æ¢ä¸ºå¦ä¸€ä¸ªå•è¯æ‰€éœ€çš„å•å­—ç¬¦ç¼–è¾‘ï¼ˆæ’å…¥ã€åˆ é™¤æˆ–æ›¿æ¢ï¼‰çš„æœ€å°æ•°é‡ã€‚<code class="language-plaintext highlighter-rouge">Levenshtein Distance</code> æ˜¯1965å¹´ç”±è‹è”æ•°å­¦å®¶ Vladimir Levenshtein å‘æ˜çš„ã€‚<code class="language-plaintext highlighter-rouge">Levenshtein Distance</code> ä¹Ÿè¢«ç§°ä¸ºç¼–è¾‘è·ç¦»ï¼ˆ<code class="language-plaintext highlighter-rouge">Edit Distance</code>ï¼‰ï¼Œé€šè¿‡<strong>åŠ¨æ€è§„åˆ’</strong>æ±‚è§£ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º <code class="language-plaintext highlighter-rouge">O(M*N)</code>ã€‚</p>

<p>å®šä¹‰ï¼šå¯¹äºä¸¤ä¸ªå­—ç¬¦ä¸² <code class="language-plaintext highlighter-rouge">aã€b</code>ï¼Œåˆ™ä»–ä»¬çš„ <code class="language-plaintext highlighter-rouge">Levenshtein Distance</code> ä¸ºï¼š</p>

<p><img src="https://user-gold-cdn.xitu.io/2019/7/23/16c1e1953b479b3d?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img" /></p>

<p>ç¤ºä¾‹ï¼šå­—ç¬¦ä¸² <code class="language-plaintext highlighter-rouge">a</code> å’Œ <code class="language-plaintext highlighter-rouge">b</code>ï¼Œ<code class="language-plaintext highlighter-rouge">a=â€œabcdeâ€ ï¼Œb=â€œcabefâ€</code>ï¼Œæ ¹æ®ä¸Šé¢ç»™å‡ºçš„è®¡ç®—å…¬å¼ï¼Œåˆ™ä»–ä»¬çš„ <code class="language-plaintext highlighter-rouge">Levenshtein Distance</code> çš„è®¡ç®—è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>

<p><img src="https://user-gold-cdn.xitu.io/2019/7/23/16c1e19bb3962ba1?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img" /></p>

<p>æœ¬æ–‡çš„ <code class="language-plaintext highlighter-rouge">demo</code> ä½¿ç”¨æ’ä»¶ <code class="language-plaintext highlighter-rouge">list-diff2</code> ç®—æ³•è¿›è¡Œæ¯”è¾ƒï¼Œè¯¥ç®—æ³•çš„æ—¶é—´å¤æ‚åº¦ä¼Ÿ <code class="language-plaintext highlighter-rouge">O(n*m)</code>ï¼Œè™½ç„¶è¯¥ç®—æ³•å¹¶éæœ€ä¼˜çš„ç®—æ³•ï¼Œä½†æ˜¯ç”¨äºå¯¹äº <code class="language-plaintext highlighter-rouge">dom</code> å…ƒç´ çš„å¸¸è§„æ“ä½œæ˜¯è¶³å¤Ÿçš„ã€‚è¯¥ç®—æ³•å…·ä½“çš„å®ç°è¿‡ç¨‹è¿™é‡Œä¸å†è¯¦ç»†ä»‹ç»ï¼Œè¯¥ç®—æ³•çš„å…·ä½“ä»‹ç»å¯ä»¥å‚ç…§ï¼š<a href="https://github.com/livoras/list-diff">github.com/livoras/lisâ€¦</a></p>

<p><strong>ï¼ˆ4ï¼‰å®ä¾‹è¾“å‡º</strong></p>

<p>ä¸¤ä¸ªè™šæ‹Ÿ <code class="language-plaintext highlighter-rouge">DOM</code> å¯¹è±¡å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå…¶ä¸­ <code class="language-plaintext highlighter-rouge">ul1</code> è¡¨ç¤ºåŸæœ‰çš„è™šæ‹Ÿ <code class="language-plaintext highlighter-rouge">DOM</code> æ ‘ï¼Œ<code class="language-plaintext highlighter-rouge">ul2</code> è¡¨ç¤ºæ”¹å˜åçš„è™šæ‹Ÿ <code class="language-plaintext highlighter-rouge">DOM</code> æ ‘</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var ul1 = el('div',{id:'virtual-dom'},[
  el('p',{},['Virtual DOM']),
  el('ul', { id: 'list' }, [
	el('li', { class: 'item' }, ['Item 1']),
	el('li', { class: 'item' }, ['Item 2']),
	el('li', { class: 'item' }, ['Item 3'])
  ]),
  el('div',{},['Hello World'])
]) 
var ul2 = el('div',{id:'virtual-dom'},[
  el('p',{},['Virtual DOM']),
  el('ul', { id: 'list' }, [
	el('li', { class: 'item' }, ['Item 21']),
	el('li', { class: 'item' }, ['Item 23'])
  ]),
  el('p',{},['Hello World'])
]) 
var patches = diff(ul1,ul2);
console.log('patches:',patches);
å¤åˆ¶ä»£ç 
</code></pre></div></div>

<p>æˆ‘ä»¬æŸ¥çœ‹è¾“å‡ºçš„ä¸¤ä¸ªè™šæ‹Ÿ <code class="language-plaintext highlighter-rouge">DOM</code> å¯¹è±¡ä¹‹é—´çš„å·®å¼‚å¯¹è±¡å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬èƒ½é€šè¿‡å·®å¼‚å¯¹è±¡å¾—åˆ°ï¼Œä¸¤ä¸ªè™šæ‹Ÿ <code class="language-plaintext highlighter-rouge">DOM</code> å¯¹è±¡ä¹‹é—´è¿›è¡Œäº†å“ªäº›å˜åŒ–ï¼Œä»è€Œæ ¹æ®è¿™ä¸ªå·®å¼‚å¯¹è±¡ï¼ˆ<code class="language-plaintext highlighter-rouge">patches</code>ï¼‰æ›´æ”¹åŸå…ˆçš„çœŸå® <code class="language-plaintext highlighter-rouge">DOM</code> ç»“æ„ï¼Œä»è€Œå°†é¡µé¢çš„ <code class="language-plaintext highlighter-rouge">DOM</code> ç»“æ„è¿›è¡Œæ›´æ”¹ã€‚</p>

<p><img src="https://user-gold-cdn.xitu.io/2019/7/23/16c1e1a5bff0b71a?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img" /></p>

<h4 id="223å°†ä¸¤ä¸ªè™šæ‹Ÿ-dom-å¯¹è±¡çš„å·®å¼‚åº”ç”¨åˆ°çœŸæ­£çš„-dom-æ ‘">2.2.3ã€å°†ä¸¤ä¸ªè™šæ‹Ÿ <code class="language-plaintext highlighter-rouge">DOM</code> å¯¹è±¡çš„å·®å¼‚åº”ç”¨åˆ°çœŸæ­£çš„ <code class="language-plaintext highlighter-rouge">DOM</code> æ ‘</h4>

<p><strong>ï¼ˆ1ï¼‰æ·±åº¦ä¼˜å…ˆéå† <code class="language-plaintext highlighter-rouge">DOM</code> æ ‘</strong></p>

<p>â€‹	å› ä¸ºæ­¥éª¤ä¸€æ‰€æ„å»ºçš„         <code class="language-plaintext highlighter-rouge">JavaScript</code> å¯¹è±¡æ ‘å’Œ <code class="language-plaintext highlighter-rouge">render</code> å‡ºæ¥çœŸæ­£çš„ <code class="language-plaintext highlighter-rouge">DOM</code> æ ‘çš„ä¿¡æ¯ã€ç»“æ„æ˜¯ä¸€æ ·çš„ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å¯¹é‚£æ£µ <code class="language-plaintext highlighter-rouge">DOM</code> æ ‘ä¹Ÿè¿›è¡Œæ·±åº¦ä¼˜å…ˆçš„éå†ï¼Œéå†çš„æ—¶å€™ä»æ­¥éª¤äºŒç”Ÿæˆçš„ <code class="language-plaintext highlighter-rouge">patches</code> å¯¹è±¡ä¸­æ‰¾å‡ºå½“å‰éå†çš„èŠ‚ç‚¹å·®å¼‚ï¼Œå¦‚ä¸‹ç›¸å…³ä»£ç æ‰€ç¤ºï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>function patch (node, patches) {
  var walker = {index: 0}
  dfsWalk(node, walker, patches)
}

function dfsWalk (node, walker, patches) {
  // ä»patchesæ‹¿å‡ºå½“å‰èŠ‚ç‚¹çš„å·®å¼‚
  var currentPatches = patches[walker.index]

  var len = node.childNodes
    ? node.childNodes.length
    : 0
  // æ·±åº¦éå†å­èŠ‚ç‚¹
  for (var i = 0; i &lt; len; i++) {
    var child = node.childNodes[i]
    walker.index++
    dfsWalk(child, walker, patches)
  }
  // å¯¹å½“å‰èŠ‚ç‚¹è¿›è¡ŒDOMæ“ä½œ
  if (currentPatches) {
    applyPatches(node, currentPatches)
  }
} 
å¤åˆ¶ä»£ç 
</code></pre></div></div>

<p><strong>ï¼ˆ2ï¼‰å¯¹åŸæœ‰ <code class="language-plaintext highlighter-rouge">DOM</code> æ ‘è¿›è¡Œ <code class="language-plaintext highlighter-rouge">DOM</code> æ“ä½œ</strong></p>

<p>æˆ‘ä»¬æ ¹æ®ä¸åŒç±»å‹çš„å·®å¼‚å¯¹å½“å‰èŠ‚ç‚¹è¿›è¡Œä¸åŒçš„ <code class="language-plaintext highlighter-rouge">DOM</code> æ“ä½œ ï¼Œä¾‹å¦‚å¦‚æœè¿›è¡Œäº†èŠ‚ç‚¹æ›¿æ¢ï¼Œå°±è¿›è¡ŒèŠ‚ç‚¹æ›¿æ¢ <code class="language-plaintext highlighter-rouge">DOM</code> æ“ä½œï¼›å¦‚æœèŠ‚ç‚¹æ–‡æœ¬å‘ç”Ÿäº†æ”¹å˜ï¼Œåˆ™è¿›è¡Œæ–‡æœ¬æ›¿æ¢çš„ <code class="language-plaintext highlighter-rouge">DOM</code> æ“ä½œï¼›ä»¥åŠå­èŠ‚ç‚¹é‡æ’ã€å±æ€§æ”¹å˜ç­‰ <code class="language-plaintext highlighter-rouge">DOM</code> æ“ä½œï¼Œç›¸å…³ä»£ç å¦‚ <code class="language-plaintext highlighter-rouge">applyPatches</code> æ‰€ç¤º ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>function applyPatches (node, currentPatches) {
  currentPatches.forEach(currentPatch =&gt; {
    switch (currentPatch.type) {
      case REPLACE:
        var newNode = (typeof currentPatch.node === 'string')
          ? document.createTextNode(currentPatch.node)
          : currentPatch.node.render()
        node.parentNode.replaceChild(newNode, node)
        break
      case REORDER:
        reorderChildren(node, currentPatch.moves)
        break
      case PROPS:
        setProps(node, currentPatch.props)
        break
      case TEXT:
        node.textContent = currentPatch.content
        break
      default:
        throw new Error('Unknown patch type ' + currentPatch.type)
    }
  })
} 
å¤åˆ¶ä»£ç 
</code></pre></div></div>

<p><strong>ï¼ˆ3ï¼‰DOMç»“æ„æ”¹å˜</strong></p>

<p>é€šè¿‡å°†ç¬¬ 2.2.2 å¾—åˆ°çš„ä¸¤ä¸ª <code class="language-plaintext highlighter-rouge">DOM</code> å¯¹è±¡ä¹‹é—´çš„å·®å¼‚ï¼Œåº”ç”¨åˆ°ç¬¬ä¸€ä¸ªï¼ˆåŸå…ˆï¼‰<code class="language-plaintext highlighter-rouge">DOM</code> ç»“æ„ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° <code class="language-plaintext highlighter-rouge">DOM</code> ç»“æ„è¿›è¡Œäº†é¢„æœŸçš„å˜åŒ–ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>

<p><img src="https://user-gold-cdn.xitu.io/2019/7/23/16c1e1ae714e9779?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img" /></p>

<h3 id="23ç»“è¯­">2.3ã€ç»“è¯­</h3>

<p>ç›¸å…³ä»£ç å®ç°å·²ç»æ”¾åˆ° github ä¸Šé¢ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥cloneè¿è¡Œå®éªŒï¼Œgithubåœ°å€ä¸ºï¼š<a href="https://github.com/fengshi123/virtual-dom-exampleã€‚">github.com/fengshi123/â€¦</a></p>

<p><code class="language-plaintext highlighter-rouge">Virtual DOM</code> ç®—æ³•ä¸»è¦å®ç°ä¸Šé¢ä¸‰ä¸ªæ­¥éª¤æ¥å®ç°ï¼š</p>

<ul>
  <li>
    <p>ç”¨ <code class="language-plaintext highlighter-rouge">JS</code> å¯¹è±¡æ¨¡æ‹Ÿ <code class="language-plaintext highlighter-rouge">DOM</code> æ ‘ â€” <code class="language-plaintext highlighter-rouge">element.js</code></p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;div id="virtual-dom"&gt;
&lt;p&gt;Virtual DOM&lt;/p&gt;
&lt;ul id="list"&gt;
  &lt;li class="item"&gt;Item 1&lt;/li&gt;
  &lt;li class="item"&gt;Item 2&lt;/li&gt;
  &lt;li class="item"&gt;Item 3&lt;/li&gt;
&lt;/ul&gt;
&lt;div&gt;Hello World&lt;/div&gt;
&lt;/div&gt; 
å¤åˆ¶ä»£ç 
</code></pre></div>    </div>
  </li>
  <li>
    <p>æ¯”è¾ƒä¸¤æ£µè™šæ‹Ÿ <code class="language-plaintext highlighter-rouge">DOM</code> æ ‘çš„å·®å¼‚ â€” <code class="language-plaintext highlighter-rouge">diff.js</code></p>
  </li>
</ul>

<p><img src="https://user-gold-cdn.xitu.io/2019/7/23/16c1e1bb518a2951?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img" /></p>

<ul>
  <li>
    <p>å°†ä¸¤ä¸ªè™šæ‹Ÿ <code class="language-plaintext highlighter-rouge">DOM</code> å¯¹è±¡çš„å·®å¼‚åº”ç”¨åˆ°çœŸæ­£çš„ <code class="language-plaintext highlighter-rouge">DOM</code> æ ‘ â€” <code class="language-plaintext highlighter-rouge">patch.js</code></p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>function applyPatches (node, currentPatches) {
  currentPatches.forEach(currentPatch =&gt; {
    switch (currentPatch.type) {
      case REPLACE:
        var newNode = (typeof currentPatch.node === 'string')
          ? document.createTextNode(currentPatch.node)
          : currentPatch.node.render()
        node.parentNode.replaceChild(newNode, node)
        break
      case REORDER:
        reorderChildren(node, currentPatch.moves)
        break
      case PROPS:
        setProps(node, currentPatch.props)
        break
      case TEXT:
        node.textContent = currentPatch.content
        break
      default:
        throw new Error('Unknown patch type ' + currentPatch.type)
    }
  })
} 
å¤åˆ¶ä»£ç 
</code></pre></div>    </div>
  </li>
</ul>

<h2 id="ä¸‰vue-æºç -virtual-dom-ç®€æ">ä¸‰ã€<code class="language-plaintext highlighter-rouge">Vue</code> æºç  <code class="language-plaintext highlighter-rouge">Virtual-DOM</code> ç®€æ</h2>

<p>æˆ‘ä»¬ä»ç¬¬äºŒç« èŠ‚ï¼ˆ<code class="language-plaintext highlighter-rouge">Virtual-DOM</code> åŸºç¡€ï¼‰ä¸­å·²ç»æŒæ¡ <code class="language-plaintext highlighter-rouge">Virtual DOM</code> æ¸²æŸ“æˆçœŸå®çš„ <code class="language-plaintext highlighter-rouge">DOM</code> å®é™…ä¸Šè¦ç»å† <code class="language-plaintext highlighter-rouge">VNode</code> çš„å®šä¹‰ã€<code class="language-plaintext highlighter-rouge">diff</code>ã€<code class="language-plaintext highlighter-rouge">patch</code> ç­‰è¿‡ç¨‹ï¼Œæ‰€ä»¥æœ¬ç« èŠ‚ <code class="language-plaintext highlighter-rouge">Vue</code> æºç çš„è§£æä¹ŸæŒ‰è¿™å‡ ä¸ªè¿‡ç¨‹æ¥ç®€æã€‚</p>

<h3 id="31vnode-æ¨¡æ‹Ÿ-dom-æ ‘">3.1ã€<code class="language-plaintext highlighter-rouge">VNode</code> æ¨¡æ‹Ÿ <code class="language-plaintext highlighter-rouge">DOM</code> æ ‘</h3>

<h4 id="311vnode-ç±»ç®€æ"><strong>3.1.1ã€<code class="language-plaintext highlighter-rouge">VNode</code> ç±»ç®€æ</strong></h4>

<p>åœ¨ <code class="language-plaintext highlighter-rouge">Vue.js</code> ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">Virtual DOM</code> æ˜¯ç”¨ <code class="language-plaintext highlighter-rouge">VNode</code> è¿™ä¸ª <code class="language-plaintext highlighter-rouge">Class</code> å»æè¿°ï¼Œå®ƒå®šä¹‰åœ¨ <code class="language-plaintext highlighter-rouge">src/core/vdom/vnode.js</code> ä¸­ ï¼Œä»ä»¥ä¸‹ä»£ç å—ä¸­å¯ä»¥çœ‹åˆ° <code class="language-plaintext highlighter-rouge">Vue.js</code> ä¸­çš„ <code class="language-plaintext highlighter-rouge">Virtual DOM</code> çš„å®šä¹‰è¾ƒä¸ºå¤æ‚ä¸€äº›ï¼Œå› ä¸ºå®ƒè¿™é‡ŒåŒ…å«äº†å¾ˆå¤š <code class="language-plaintext highlighter-rouge">Vue.js</code> çš„ç‰¹æ€§ã€‚å®é™…ä¸Š <code class="language-plaintext highlighter-rouge">Vue.js</code> ä¸­ <code class="language-plaintext highlighter-rouge">Virtual DOM</code> æ˜¯å€Ÿé‰´äº†ä¸€ä¸ªå¼€æºåº“  <a href="https://github.com/snabbdom/snabbdom">snabbdom</a> çš„å®ç°ï¼Œç„¶ååŠ å…¥äº†ä¸€äº› <code class="language-plaintext highlighter-rouge">Vue.js</code> çš„ä¸€äº›ç‰¹æ€§ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export default class VNode {
  tag: string | void;
  data: VNodeData | void;
  children: ?Array&lt;VNode&gt;;
  text: string | void;
  elm: Node | void;
  ns: string | void;
  context: Component | void; // rendered in this component's scope
  key: string | number | void;
  componentOptions: VNodeComponentOptions | void;
  componentInstance: Component | void; // component instance
  parent: VNode | void; // component placeholder node

  // strictly internal
  raw: boolean; // contains raw HTML? (server only)
  isStatic: boolean; // hoisted static node
  isRootInsert: boolean; // necessary for enter transition check
  isComment: boolean; // empty comment placeholder?
  isCloned: boolean; // is a cloned node?
  isOnce: boolean; // is a v-once node?
  asyncFactory: Function | void; // async component factory function
  asyncMeta: Object | void;
  isAsyncPlaceholder: boolean;
  ssrContext: Object | void;
  fnContext: Component | void; // real context vm for functional nodes
  fnOptions: ?ComponentOptions; // for SSR caching
  devtoolsMeta: ?Object; // used to store functional render context for devtools
  fnScopeId: ?string; // functional scope id support

  constructor (
    tag?: string,
    data?: VNodeData,
    children?: ?Array&lt;VNode&gt;,
    text?: string,
    elm?: Node,
    context?: Component,
    componentOptions?: VNodeComponentOptions,
    asyncFactory?: Function
  ) {
    this.tag = tag
    this.data = data
    this.children = children
    this.text = text
    this.elm = elm
    this.ns = undefined
    this.context = context
    this.fnContext = undefined
    this.fnOptions = undefined
    this.fnScopeId = undefined
    this.key = data &amp;&amp; data.key
    this.componentOptions = componentOptions
    this.componentInstance = undefined
    this.parent = undefined
    this.raw = false
    this.isStatic = false
    this.isRootInsert = true
    this.isComment = false
    this.isCloned = false
    this.isOnce = false
    this.asyncFactory = asyncFactory
    this.asyncMeta = undefined
    this.isAsyncPlaceholder = false
  }
}
å¤åˆ¶ä»£ç 
</code></pre></div></div>

<p>è¿™é‡Œåƒä¸‡ä¸è¦å› ä¸º <code class="language-plaintext highlighter-rouge">VNode</code> çš„è¿™ä¹ˆå±æ€§è€Œè¢«å“åˆ°ï¼Œæˆ–è€…å’¬ç´§ç‰™å»æ‘¸æ¸…æ¥šæ¯ä¸ªå±æ€§çš„æ„ä¹‰ï¼Œå…¶å®ï¼Œæˆ‘ä»¬ä¸»è¦äº†è§£å…¶å‡ ä¸ªæ ¸å¿ƒçš„å…³é”®å±æ€§å°±å·®ä¸å¤šäº†ï¼Œä¾‹å¦‚ï¼š</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">tag</code> å±æ€§å³è¿™ä¸ª<code class="language-plaintext highlighter-rouge">vnode</code>çš„æ ‡ç­¾å±æ€§</li>
  <li><code class="language-plaintext highlighter-rouge">data</code> å±æ€§åŒ…å«äº†æœ€åæ¸²æŸ“æˆçœŸå®<code class="language-plaintext highlighter-rouge">dom</code>èŠ‚ç‚¹åï¼ŒèŠ‚ç‚¹ä¸Šçš„<code class="language-plaintext highlighter-rouge">class</code>ï¼Œ<code class="language-plaintext highlighter-rouge">attribute</code>ï¼Œ<code class="language-plaintext highlighter-rouge">style</code>ä»¥åŠç»‘å®šçš„äº‹ä»¶</li>
  <li><code class="language-plaintext highlighter-rouge">children</code> å±æ€§æ˜¯<code class="language-plaintext highlighter-rouge">vnode</code>çš„å­èŠ‚ç‚¹</li>
  <li><code class="language-plaintext highlighter-rouge">text</code> å±æ€§æ˜¯æ–‡æœ¬å±æ€§</li>
  <li><code class="language-plaintext highlighter-rouge">elm</code> å±æ€§ä¸ºè¿™ä¸ª<code class="language-plaintext highlighter-rouge">vnode</code>å¯¹åº”çš„çœŸå®<code class="language-plaintext highlighter-rouge">dom</code>èŠ‚ç‚¹</li>
  <li><code class="language-plaintext highlighter-rouge">key</code> å±æ€§æ˜¯<code class="language-plaintext highlighter-rouge">vnode</code>çš„æ ‡è®°ï¼Œåœ¨<code class="language-plaintext highlighter-rouge">diff</code>è¿‡ç¨‹ä¸­å¯ä»¥æé«˜<code class="language-plaintext highlighter-rouge">diff</code>çš„æ•ˆç‡</li>
</ul>

<h4 id="312æºç åˆ›å»º-vnode-è¿‡ç¨‹">3.1.2ã€æºç åˆ›å»º <code class="language-plaintext highlighter-rouge">VNode</code> è¿‡ç¨‹</h4>

<p>ï¼ˆ1ï¼‰åˆå§‹åŒ–vue</p>

<p>æˆ‘ä»¬åœ¨å®ä¾‹åŒ–ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">vue</code> å®ä¾‹ï¼Œä¹Ÿå³ <code class="language-plaintext highlighter-rouge">new Vue( )</code> æ—¶ï¼Œå®é™…ä¸Šæ˜¯æ‰§è¡Œ <code class="language-plaintext highlighter-rouge">src/core/instance/index.js</code>  ä¸­å®šä¹‰çš„ <code class="language-plaintext highlighter-rouge">Function</code> å‡½æ•°ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>function Vue (options) {
  if (process.env.NODE_ENV !== 'production' &amp;&amp;
    !(this instanceof Vue)
  ) {
    warn('Vue is a constructor and should be called with the `new` keyword')
  }
  this._init(options)
}
å¤åˆ¶ä»£ç 
</code></pre></div></div>

<p>é€šè¿‡æŸ¥çœ‹ <code class="language-plaintext highlighter-rouge">Vue</code> çš„ <code class="language-plaintext highlighter-rouge">function</code>ï¼Œæˆ‘ä»¬çŸ¥é“ <code class="language-plaintext highlighter-rouge">Vue</code> åªèƒ½é€šè¿‡ <code class="language-plaintext highlighter-rouge">new</code> å…³é”®å­—åˆå§‹åŒ–ï¼Œç„¶åè°ƒç”¨ <code class="language-plaintext highlighter-rouge">this._init</code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•åœ¨ <code class="language-plaintext highlighter-rouge">src/core/instance/init.js</code> ä¸­å®šä¹‰ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  Vue.prototype._init = function (options?: Object) {
    const vm: Component = this
      
    // çœç•¥ä¸€ç³»åˆ—å…¶å®ƒåˆå§‹åŒ–çš„ä»£ç 
      
    if (vm.$options.el) {
      console.log('vm.$options.el:',vm.$options.el);
      vm.$mount(vm.$options.el)
    }
  }
å¤åˆ¶ä»£ç 
</code></pre></div></div>

<p><strong>ï¼ˆ2ï¼‰<code class="language-plaintext highlighter-rouge">Vue</code> å®ä¾‹æŒ‚è½½</strong></p>

<p><code class="language-plaintext highlighter-rouge">Vue</code> ä¸­æ˜¯é€šè¿‡ <code class="language-plaintext highlighter-rouge">$mount</code> å®ä¾‹æ–¹æ³•å»æŒ‚è½½ <code class="language-plaintext highlighter-rouge">dom</code> çš„ï¼Œä¸‹é¢æˆ‘ä»¬é€šè¿‡åˆ†æ <code class="language-plaintext highlighter-rouge">compiler</code> ç‰ˆæœ¬çš„ <code class="language-plaintext highlighter-rouge">mount</code> å®ç°ï¼Œç›¸å…³æºç åœ¨ç›®å½• <code class="language-plaintext highlighter-rouge">src/platforms/web/entry-runtime-with-compiler.js</code> æ–‡ä»¶ä¸­å®šä¹‰ï¼šã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const mount = Vue.prototype.$mount
Vue.prototype.$mount = function (
  el?: string | Element,
  hydrating?: boolean
): Component {
  el = el &amp;&amp; query(el)
  
   // çœç•¥ä¸€ç³»åˆ—åˆå§‹åŒ–ä»¥åŠé€»è¾‘åˆ¤æ–­ä»£ç   
 
  return mount.call(this, el, hydrating)
}
å¤åˆ¶ä»£ç 
</code></pre></div></div>

<p>æˆ‘ä»¬å‘ç°æœ€ç»ˆè¿˜æ˜¯è°ƒç”¨ç”¨åŸå…ˆåŸå‹ä¸Šçš„ <code class="language-plaintext highlighter-rouge">$mount</code> æ–¹æ³•æŒ‚è½½ ï¼ŒåŸå…ˆåŸå‹ä¸Šçš„ <code class="language-plaintext highlighter-rouge">$mount</code> æ–¹æ³•åœ¨ <code class="language-plaintext highlighter-rouge">src/platforms/web/runtime/index.js</code> ä¸­å®šä¹‰ ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Vue.prototype.$mount = function (
  el?: string | Element,
  hydrating?: boolean
): Component {
  el = el &amp;&amp; inBrowser ? query(el) : undefined
  return mountComponent(this, el, hydrating)
}
å¤åˆ¶ä»£ç 
</code></pre></div></div>

<p>æˆ‘ä»¬å‘ç°<code class="language-plaintext highlighter-rouge">$mount</code> æ–¹æ³•å®é™…ä¸Šä¼šå»è°ƒç”¨ <code class="language-plaintext highlighter-rouge">mountComponent</code> æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å®šä¹‰åœ¨ <code class="language-plaintext highlighter-rouge">src/core/instance/lifecycle.js</code> æ–‡ä»¶ä¸­</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export function mountComponent (
  vm: Component,
  el: ?Element,
  hydrating?: boolean
): Component {
  vm.$el = el
  // çœç•¥ä¸€ç³»åˆ—å…¶å®ƒä»£ç 
  let updateComponent
  /* istanbul ignore if */
  if (process.env.NODE_ENV !== 'production' &amp;&amp; config.performance &amp;&amp; mark) {
    updateComponent = () =&gt; {
      // ç”Ÿæˆè™šæ‹Ÿ vnode   
      const vnode = vm._render()
      // æ›´æ–° DOM
      vm._update(vnode, hydrating)
     
    }
  } else {
    updateComponent = () =&gt; {
      vm._update(vm._render(), hydrating)
    }
  }

  // å®ä¾‹åŒ–ä¸€ä¸ªæ¸²æŸ“Watcherï¼Œåœ¨å®ƒçš„å›è°ƒå‡½æ•°ä¸­ä¼šè°ƒç”¨ updateComponent æ–¹æ³•  
  new Watcher(vm, updateComponent, noop, {
    before () {
      if (vm._isMounted &amp;&amp; !vm._isDestroyed) {
        callHook(vm, 'beforeUpdate')
      }
    }
  }, true /* isRenderWatcher */)
  hydrating = false

  return vm
}
å¤åˆ¶ä»£ç 
</code></pre></div></div>

<p>ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œ<code class="language-plaintext highlighter-rouge">mountComponent</code> æ ¸å¿ƒå°±æ˜¯å…ˆå®ä¾‹åŒ–ä¸€ä¸ªæ¸²æŸ“<code class="language-plaintext highlighter-rouge">Watcher</code>ï¼Œåœ¨å®ƒçš„å›è°ƒå‡½æ•°ä¸­ä¼šè°ƒç”¨ <code class="language-plaintext highlighter-rouge">updateComponent</code> æ–¹æ³•ï¼Œåœ¨æ­¤æ–¹æ³•ä¸­è°ƒç”¨ <code class="language-plaintext highlighter-rouge">vm._render</code> æ–¹æ³•å…ˆç”Ÿæˆè™šæ‹Ÿ Nodeï¼Œæœ€ç»ˆè°ƒç”¨ <code class="language-plaintext highlighter-rouge">vm._update</code> æ›´æ–° <code class="language-plaintext highlighter-rouge">DOM</code>ã€‚</p>

<p><strong>ï¼ˆ3ï¼‰åˆ›å»ºè™šæ‹Ÿ Node</strong></p>

<p><code class="language-plaintext highlighter-rouge">Vue</code> çš„ <code class="language-plaintext highlighter-rouge">_render</code> æ–¹æ³•æ˜¯å®ä¾‹çš„ä¸€ä¸ªç§æœ‰æ–¹æ³•ï¼Œå®ƒç”¨æ¥æŠŠå®ä¾‹æ¸²æŸ“æˆä¸€ä¸ªè™šæ‹Ÿ <code class="language-plaintext highlighter-rouge">Node</code>ã€‚å®ƒçš„å®šä¹‰åœ¨ <code class="language-plaintext highlighter-rouge">src/core/instance/render.js</code> æ–‡ä»¶ä¸­ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> Vue.prototype._render = function (): VNode {
    const vm: Component = this
    const { render, _parentVnode } = vm.$options
    let vnode
    try {
      // çœç•¥ä¸€ç³»åˆ—ä»£ç   
      currentRenderingInstance = vm
      // è°ƒç”¨ createElement æ–¹æ³•æ¥è¿”å› vnode
      vnode = render.call(vm._renderProxy, vm.$createElement)
    } catch (e) {
      handleError(e, vm, `render`){}
    }
    // set parent
    vnode.parent = _parentVnode
    console.log("vnode...:",vnode);
    return vnode
  }
å¤åˆ¶ä»£ç 
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Vue.js</code> åˆ©ç”¨ <code class="language-plaintext highlighter-rouge">_createElement</code> æ–¹æ³•åˆ›å»º <code class="language-plaintext highlighter-rouge">VNode</code>ï¼Œå®ƒå®šä¹‰åœ¨ <code class="language-plaintext highlighter-rouge">src/core/vdom/create-elemenet.js</code> ä¸­ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export function _createElement (
  context: Component,
  tag?: string | Class&lt;Component&gt; | Function | Object,
  data?: VNodeData,
  children?: any,
  normalizationType?: number
): VNode | Array&lt;VNode&gt; {
    
  // çœç•¥ä¸€ç³»åˆ—éä¸»çº¿ä»£ç 
  
  if (normalizationType === ALWAYS_NORMALIZE) {
    // åœºæ™¯æ˜¯ render å‡½æ•°ä¸æ˜¯ç¼–è¯‘ç”Ÿæˆçš„
    children = normalizeChildren(children)
  } else if (normalizationType === SIMPLE_NORMALIZE) {
    // åœºæ™¯æ˜¯ render å‡½æ•°æ˜¯ç¼–è¯‘ç”Ÿæˆçš„
    children = simpleNormalizeChildren(children)
  }
  let vnode, ns
  if (typeof tag === 'string') {
    let Ctor
    ns = (context.$vnode &amp;&amp; context.$vnode.ns) || config.getTagNamespace(tag)
    if (config.isReservedTag(tag)) {
      // åˆ›å»ºè™šæ‹Ÿ vnode
      vnode = new VNode(
        config.parsePlatformTagName(tag), data, children,
        undefined, undefined, context
      )
    } else if ((!data || !data.pre) &amp;&amp; isDef(Ctor = resolveAsset(context.$options, 'components', tag))) {
      // component
      vnode = createComponent(Ctor, data, context, children, tag)
    } else {
      vnode = new VNode(
        tag, data, children,
        undefined, undefined, context
      )
    }
  } else {
    vnode = createComponent(tag, data, context, children)
  }
  if (Array.isArray(vnode)) {
    return vnode
  } else if (isDef(vnode)) {
    if (isDef(ns)) applyNS(vnode, ns)
    if (isDef(data)) registerDeepBindings(data)
    return vnode
  } else {
    return createEmptyVNode()
  }
}
å¤åˆ¶ä»£ç 
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">_createElement</code> æ–¹æ³•æœ‰ 5 ä¸ªå‚æ•°ï¼Œ<code class="language-plaintext highlighter-rouge">context</code> è¡¨ç¤º VNode çš„ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œå®ƒæ˜¯ <code class="language-plaintext highlighter-rouge">Component</code> ç±»å‹ï¼›<code class="language-plaintext highlighter-rouge">tag</code>è¡¨ç¤ºæ ‡ç­¾ï¼Œå®ƒå¯ä»¥æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">Component</code>ï¼›<code class="language-plaintext highlighter-rouge">data</code> è¡¨ç¤º VNode çš„æ•°æ®ï¼Œå®ƒæ˜¯ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">VNodeData</code> ç±»å‹ï¼Œå¯ä»¥åœ¨ <code class="language-plaintext highlighter-rouge">flow/vnode.js</code> ä¸­æ‰¾åˆ°å®ƒçš„å®šä¹‰ï¼›<code class="language-plaintext highlighter-rouge">children</code> è¡¨ç¤ºå½“å‰ VNode çš„å­èŠ‚ç‚¹ï¼Œå®ƒæ˜¯ä»»æ„ç±»å‹çš„ï¼Œéœ€è¦è¢«è§„èŒƒä¸ºæ ‡å‡†çš„ <code class="language-plaintext highlighter-rouge">VNode</code> æ•°ç»„ï¼›</p>

<h4 id="313å®ä¾‹æŸ¥çœ‹"><strong>3.1.3ã€å®ä¾‹æŸ¥çœ‹</strong></h4>

<p>ä¸ºäº†æ›´ç›´è§‚æŸ¥çœ‹æˆ‘ä»¬å¹³æ—¶å†™çš„ <code class="language-plaintext highlighter-rouge">Vue</code> ä»£ç å¦‚ä½•ç”¨ <code class="language-plaintext highlighter-rouge">VNode</code> ç±»æ¥è¡¨ç¤ºï¼Œæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå®ä¾‹çš„è½¬æ¢è¿›è¡Œæ›´æ·±åˆ»äº†è§£ã€‚</p>

<p>ä¾‹å¦‚ï¼Œå®ä¾‹åŒ–ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">Vue</code> å®ä¾‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  var app = new Vue({
    el: '#app',
    render: function (createElement) {
      return createElement('div', {
        attrs: {
          id: 'app',
          class: "class_box"
        },
      }, this.message)
    },
    data: {
      message: 'Hello Vue!'
    }
  })
å¤åˆ¶ä»£ç 
</code></pre></div></div>

<p>æˆ‘ä»¬æ‰“å°å‡ºå…¶å¯¹åº”çš„ <code class="language-plaintext highlighter-rouge">VNode</code> è¡¨ç¤ºï¼š</p>

<p><img src="https://user-gold-cdn.xitu.io/2019/7/23/16c1e23b7481b16f?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img" /></p>

<h3 id="32diff-è¿‡ç¨‹">3.2ã€<code class="language-plaintext highlighter-rouge">diff</code> è¿‡ç¨‹</h3>

<h4 id="321vuejs-æºç çš„-diff-è°ƒç”¨é€»è¾‘">3.2.1ã€<code class="language-plaintext highlighter-rouge">Vue.js</code> æºç çš„ <code class="language-plaintext highlighter-rouge">diff</code> è°ƒç”¨é€»è¾‘</h4>

<p><code class="language-plaintext highlighter-rouge">Vue.js</code> æºç å®ä¾‹åŒ–äº†ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">watcher</code>ï¼Œè¿™ä¸ª ~ è¢«æ·»åŠ åˆ°äº†åœ¨æ¨¡æ¿å½“ä¸­æ‰€ç»‘å®šå˜é‡çš„ä¾èµ–å½“ä¸­ï¼Œä¸€æ—¦ <code class="language-plaintext highlighter-rouge">model</code> ä¸­çš„å“åº”å¼çš„æ•°æ®å‘ç”Ÿäº†å˜åŒ–ï¼Œè¿™äº›å“åº”å¼çš„æ•°æ®æ‰€ç»´æŠ¤çš„ <code class="language-plaintext highlighter-rouge">dep</code> æ•°ç»„ä¾¿ä¼šè°ƒç”¨ <code class="language-plaintext highlighter-rouge">dep.notify()</code> æ–¹æ³•å®Œæˆæ‰€æœ‰ä¾èµ–éå†æ‰§è¡Œçš„å·¥ä½œï¼Œè¿™åŒ…æ‹¬è§†å›¾çš„æ›´æ–°ï¼Œå³ <code class="language-plaintext highlighter-rouge">updateComponent</code> æ–¹æ³•çš„è°ƒç”¨ã€‚<code class="language-plaintext highlighter-rouge">watcher</code> å’Œ <code class="language-plaintext highlighter-rouge">updateComponent</code>æ–¹æ³•å®šä¹‰åœ¨  <code class="language-plaintext highlighter-rouge">src/core/instance/lifecycle.js</code> æ–‡ä»¶ä¸­ ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export function mountComponent (
  vm: Component,
  el: ?Element,
  hydrating?: boolean
): Component {
  vm.$el = el
  // çœç•¥ä¸€ç³»åˆ—å…¶å®ƒä»£ç 
  let updateComponent
  /* istanbul ignore if */
  if (process.env.NODE_ENV !== 'production' &amp;&amp; config.performance &amp;&amp; mark) {
    updateComponent = () =&gt; {
      // ç”Ÿæˆè™šæ‹Ÿ vnode   
      const vnode = vm._render()
      // æ›´æ–° DOM
      vm._update(vnode, hydrating)
     
    }
  } else {
    updateComponent = () =&gt; {
      vm._update(vm._render(), hydrating)
    }
  }

  // å®ä¾‹åŒ–ä¸€ä¸ªæ¸²æŸ“Watcherï¼Œåœ¨å®ƒçš„å›è°ƒå‡½æ•°ä¸­ä¼šè°ƒç”¨ updateComponent æ–¹æ³•  
  new Watcher(vm, updateComponent, noop, {
    before () {
      if (vm._isMounted &amp;&amp; !vm._isDestroyed) {
        callHook(vm, 'beforeUpdate')
      }
    }
  }, true /* isRenderWatcher */)
  hydrating = false

  return vm
}
å¤åˆ¶ä»£ç 
</code></pre></div></div>

<p>å®Œæˆè§†å›¾çš„æ›´æ–°å·¥ä½œäº‹å®ä¸Šå°±æ˜¯è°ƒç”¨äº†<code class="language-plaintext highlighter-rouge">vm._update</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ¥æ”¶çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯åˆšç”Ÿæˆçš„<code class="language-plaintext highlighter-rouge">Vnode</code>ï¼Œè°ƒç”¨çš„<code class="language-plaintext highlighter-rouge">vm._update</code>æ–¹æ³•å®šä¹‰åœ¨ <code class="language-plaintext highlighter-rouge">src/core/instance/lifecycle.js</code>ä¸­ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  Vue.prototype._update = function (vnode: VNode, hydrating?: boolean) {
    const vm: Component = this
    const prevEl = vm.$el
    const prevVnode = vm._vnode
    const restoreActiveInstance = setActiveInstance(vm)
    vm._vnode = vnode
    if (!prevVnode) {
      // ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºçœŸå®çš„nodeèŠ‚ç‚¹ï¼Œåˆ™ä¸ºåˆå§‹åŒ–
      vm.$el = vm.__patch__(vm.$el, vnode, hydrating, false /* removeOnly */)
    } else {
      // å¦‚æœéœ€è¦diffçš„prevVnodeå­˜åœ¨ï¼Œé‚£ä¹ˆå¯¹prevVnodeå’Œvnodeè¿›è¡Œdiff
      vm.$el = vm.__patch__(prevVnode, vnode)
    }
    restoreActiveInstance()
    // update __vue__ reference
    if (prevEl) {
      prevEl.__vue__ = null
    }
    if (vm.$el) {
      vm.$el.__vue__ = vm
    }
    // if parent is an HOC, update its $el as well
    if (vm.$vnode &amp;&amp; vm.$parent &amp;&amp; vm.$vnode === vm.$parent._vnode) {
      vm.$parent.$el = vm.$el
    }
  }
å¤åˆ¶ä»£ç 
</code></pre></div></div>

<p>åœ¨è¿™ä¸ªæ–¹æ³•å½“ä¸­æœ€ä¸ºå…³é”®çš„å°±æ˜¯ <code class="language-plaintext highlighter-rouge">vm.__patch__</code> æ–¹æ³•ï¼Œè¿™ä¹Ÿæ˜¯æ•´ä¸ª <code class="language-plaintext highlighter-rouge">virtual-dom</code> å½“ä¸­æœ€ä¸ºæ ¸å¿ƒçš„æ–¹æ³•ï¼Œä¸»è¦å®Œæˆäº†<code class="language-plaintext highlighter-rouge">prevVnode</code> å’Œ <code class="language-plaintext highlighter-rouge">vnode</code> çš„ <code class="language-plaintext highlighter-rouge">diff</code> è¿‡ç¨‹å¹¶æ ¹æ®éœ€è¦æ“ä½œçš„ <code class="language-plaintext highlighter-rouge">vdom</code> èŠ‚ç‚¹æ‰“ <code class="language-plaintext highlighter-rouge">patch</code>ï¼Œæœ€åç”Ÿæˆæ–°çš„çœŸå® <code class="language-plaintext highlighter-rouge">dom</code> èŠ‚ç‚¹å¹¶å®Œæˆè§†å›¾çš„æ›´æ–°å·¥ä½œã€‚</p>

<p>æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬çœ‹ä¸‹ <code class="language-plaintext highlighter-rouge">vm.__patch__</code>çš„é€»è¾‘è¿‡ç¨‹ï¼Œ <code class="language-plaintext highlighter-rouge">vm.__patch__</code> æ–¹æ³•å®šä¹‰åœ¨ <code class="language-plaintext highlighter-rouge">src/core/vdom/patch.js</code> ä¸­ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>function patch (oldVnode, vnode, hydrating, removeOnly) {
    ......
    if (isUndef(oldVnode)) {
      // å½“oldVnodeä¸å­˜åœ¨æ—¶ï¼Œåˆ›å»ºæ–°çš„èŠ‚ç‚¹
      isInitialPatch = true
      createElm(vnode, insertedVnodeQueue)
    } else {
      // å¯¹oldVnodeå’Œvnodeè¿›è¡Œdiffï¼Œå¹¶å¯¹oldVnodeæ‰“patch  
      const isRealElement = isDef(oldVnode.nodeType)
      if (!isRealElement &amp;&amp; sameVnode(oldVnode, vnode)) {
        // patch existing root node
        patchVnode(oldVnode, vnode, insertedVnodeQueue, null, null, removeOnly)
      } 
	......
  }
}
å¤åˆ¶ä»£ç 
</code></pre></div></div>

<p>åœ¨ <code class="language-plaintext highlighter-rouge">patch</code> æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°ä¼šåˆ†ä¸ºä¸¤ç§æƒ…å†µï¼Œä¸€ç§æ˜¯å½“ <code class="language-plaintext highlighter-rouge">oldVnode</code> ä¸å­˜åœ¨æ—¶ï¼Œä¼šåˆ›å»ºæ–°çš„èŠ‚ç‚¹ï¼›å¦ä¸€ç§åˆ™æ˜¯å·²ç»å­˜åœ¨ <code class="language-plaintext highlighter-rouge">oldVnode</code> ï¼Œé‚£ä¹ˆä¼šå¯¹ <code class="language-plaintext highlighter-rouge">oldVnode</code> å’Œ <code class="language-plaintext highlighter-rouge">vnode</code> è¿›è¡Œ <code class="language-plaintext highlighter-rouge">diff</code> åŠ <code class="language-plaintext highlighter-rouge">patch</code> çš„è¿‡ç¨‹ã€‚å…¶ä¸­ <code class="language-plaintext highlighter-rouge">patch</code> è¿‡ç¨‹ä¸­ä¼šè°ƒç”¨ <code class="language-plaintext highlighter-rouge">sameVnode</code> æ–¹æ³•æ¥å¯¹å¯¹ä¼ å…¥çš„2ä¸ª <code class="language-plaintext highlighter-rouge">vnode</code> è¿›è¡ŒåŸºæœ¬å±æ€§çš„æ¯”è¾ƒï¼Œåªæœ‰å½“åŸºæœ¬å±æ€§ç›¸åŒçš„æƒ…å†µä¸‹æ‰è®¤ä¸ºè¿™ä¸ª2ä¸ª<code class="language-plaintext highlighter-rouge">vnode</code> åªæ˜¯å±€éƒ¨å‘ç”Ÿäº†æ›´æ–°ï¼Œç„¶åæ‰ä¼šå¯¹è¿™2ä¸ª <code class="language-plaintext highlighter-rouge">vnode</code> è¿›è¡Œ <code class="language-plaintext highlighter-rouge">diff</code>ï¼Œå¦‚æœ2ä¸ª <code class="language-plaintext highlighter-rouge">vnode</code> çš„åŸºæœ¬å±æ€§å­˜åœ¨ä¸ä¸€è‡´çš„æƒ…å†µï¼Œé‚£ä¹ˆå°±ä¼šç›´æ¥è·³è¿‡ <code class="language-plaintext highlighter-rouge">diff</code> çš„è¿‡ç¨‹ï¼Œè¿›è€Œä¾æ® <code class="language-plaintext highlighter-rouge">vnode</code> æ–°å»ºä¸€ä¸ªçœŸå®çš„ <code class="language-plaintext highlighter-rouge">dom</code>ï¼ŒåŒæ—¶åˆ é™¤è€çš„ <code class="language-plaintext highlighter-rouge">dom</code>èŠ‚ç‚¹ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>function sameVnode (a, b) {
  return (
    a.key === b.key &amp;&amp;
    a.tag === b.tag &amp;&amp;
    a.isComment === b.isComment &amp;&amp;
    isDef(a.data) === isDef(b.data) &amp;&amp;
    sameInputType(a, b)
  )
}
å¤åˆ¶ä»£ç 
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">diff</code> è¿‡ç¨‹ä¸­ä¸»è¦æ˜¯é€šè¿‡è°ƒç”¨ <code class="language-plaintext highlighter-rouge">patchVnode</code> æ–¹æ³•è¿›è¡Œçš„:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  function patchVnode (oldVnode, vnode, insertedVnodeQueue, ownerArray, index, removeOnly) {
    ...... 
    const elm = vnode.elm = oldVnode.elm
    const oldCh = oldVnode.children
    const ch = vnode.children
    // å¦‚æœvnodeæ²¡æœ‰æ–‡æœ¬èŠ‚ç‚¹
    if (isUndef(vnode.text)) {
      // å¦‚æœoldVnodeçš„childrenå±æ€§å­˜åœ¨ä¸”vnodeçš„childrenå±æ€§ä¹Ÿå­˜åœ¨  
      if (isDef(oldCh) &amp;&amp; isDef(ch)) {
        // updateChildrenï¼Œå¯¹å­èŠ‚ç‚¹è¿›è¡Œdiff  
        if (oldCh !== ch) updateChildren(elm, oldCh, ch, insertedVnodeQueue, removeOnly)
      } else if (isDef(ch)) {
        if (process.env.NODE_ENV !== 'production') {
          checkDuplicateKeys(ch)
        }
        // å¦‚æœoldVnodeçš„textå­˜åœ¨ï¼Œé‚£ä¹ˆé¦–å…ˆæ¸…ç©ºtextçš„å†…å®¹,ç„¶åå°†vnodeçš„childrenæ·»åŠ è¿›å»  
        if (isDef(oldVnode.text)) nodeOps.setTextContent(elm, '')
        addVnodes(elm, null, ch, 0, ch.length - 1, insertedVnodeQueue)
      } else if (isDef(oldCh)) {
        // åˆ é™¤elmä¸‹çš„oldchildren
        removeVnodes(elm, oldCh, 0, oldCh.length - 1)
      } else if (isDef(oldVnode.text)) {
        // oldVnodeæœ‰å­èŠ‚ç‚¹ï¼Œè€Œvnodeæ²¡æœ‰ï¼Œé‚£ä¹ˆå°±æ¸…ç©ºè¿™ä¸ªèŠ‚ç‚¹  
        nodeOps.setTextContent(elm, '')
      }
    } else if (oldVnode.text !== vnode.text) {
      // å¦‚æœoldVnodeå’Œvnodeæ–‡æœ¬å±æ€§ä¸åŒï¼Œé‚£ä¹ˆç›´æ¥æ›´æ–°çœŸæ˜¯domèŠ‚ç‚¹çš„æ–‡æœ¬å…ƒç´ 
      nodeOps.setTextContent(elm, vnode.text)
    }
    ......
  }
å¤åˆ¶ä»£ç 
</code></pre></div></div>

<p>ä»ä»¥ä¸Šä»£ç å¾—çŸ¥ï¼Œ</p>

<p><code class="language-plaintext highlighter-rouge">diff</code> è¿‡ç¨‹ä¸­åˆåˆ†äº†å¥½å‡ ç§æƒ…å†µï¼Œ<code class="language-plaintext highlighter-rouge">oldCh</code> ä¸º <code class="language-plaintext highlighter-rouge">oldVnode</code>çš„å­èŠ‚ç‚¹ï¼Œ<code class="language-plaintext highlighter-rouge">ch</code> ä¸º <code class="language-plaintext highlighter-rouge">Vnode</code>çš„å­èŠ‚ç‚¹ï¼š</p>

<ul>
  <li>é¦–å…ˆè¿›è¡Œæ–‡æœ¬èŠ‚ç‚¹çš„åˆ¤æ–­ï¼Œè‹¥ <code class="language-plaintext highlighter-rouge">oldVnode.text !== vnode.text</code>ï¼Œé‚£ä¹ˆå°±ä¼šç›´æ¥è¿›è¡Œæ–‡æœ¬èŠ‚ç‚¹çš„æ›¿æ¢ï¼›</li>
  <li>åœ¨<code class="language-plaintext highlighter-rouge">vnode</code>  æ²¡æœ‰æ–‡æœ¬èŠ‚ç‚¹çš„æƒ…å†µä¸‹ï¼Œè¿›å…¥å­èŠ‚ç‚¹çš„ <code class="language-plaintext highlighter-rouge">diff</code>ï¼›</li>
  <li>å½“ <code class="language-plaintext highlighter-rouge">oldCh</code> å’Œ <code class="language-plaintext highlighter-rouge">ch</code> éƒ½å­˜åœ¨ä¸”ä¸ç›¸åŒçš„æƒ…å†µä¸‹ï¼Œè°ƒç”¨ <code class="language-plaintext highlighter-rouge">updateChildren</code> å¯¹å­èŠ‚ç‚¹è¿›è¡Œ <code class="language-plaintext highlighter-rouge">diff</code>ï¼›</li>
  <li>è‹¥ <code class="language-plaintext highlighter-rouge">oldCh</code>ä¸å­˜åœ¨ï¼Œ<code class="language-plaintext highlighter-rouge">ch</code> å­˜åœ¨ï¼Œé¦–å…ˆæ¸…ç©º <code class="language-plaintext highlighter-rouge">oldVnode</code> çš„æ–‡æœ¬èŠ‚ç‚¹ï¼ŒåŒæ—¶è°ƒç”¨ <code class="language-plaintext highlighter-rouge">addVnodes</code> æ–¹æ³•å°† <code class="language-plaintext highlighter-rouge">ch</code> æ·»åŠ åˆ°<code class="language-plaintext highlighter-rouge">elm</code>çœŸå® <code class="language-plaintext highlighter-rouge">dom</code> èŠ‚ç‚¹å½“ä¸­ï¼›</li>
  <li>è‹¥ <code class="language-plaintext highlighter-rouge">oldCh</code>å­˜åœ¨ï¼Œ<code class="language-plaintext highlighter-rouge">ch</code>ä¸å­˜åœ¨ï¼Œåˆ™åˆ é™¤ <code class="language-plaintext highlighter-rouge">elm</code> çœŸå®èŠ‚ç‚¹ä¸‹çš„ <code class="language-plaintext highlighter-rouge">oldCh</code> å­èŠ‚ç‚¹ï¼›</li>
  <li>è‹¥ <code class="language-plaintext highlighter-rouge">oldVnode</code> æœ‰æ–‡æœ¬èŠ‚ç‚¹ï¼Œè€Œ <code class="language-plaintext highlighter-rouge">vnode</code> æ²¡æœ‰ï¼Œé‚£ä¹ˆå°±æ¸…ç©ºè¿™ä¸ªæ–‡æœ¬èŠ‚ç‚¹ã€‚</li>
</ul>

<h4 id="322å­èŠ‚ç‚¹-diff-æµç¨‹åˆ†æ">3.2.2ã€å­èŠ‚ç‚¹ <code class="language-plaintext highlighter-rouge">diff</code> æµç¨‹åˆ†æ</h4>

<p><strong>ï¼ˆ1ï¼‰<code class="language-plaintext highlighter-rouge">Vue.js</code> æºç </strong></p>

<p>â€‹	è¿™é‡Œç€é‡åˆ†æä¸‹<code class="language-plaintext highlighter-rouge">updateChildren</code>æ–¹æ³•ï¼Œå®ƒä¹Ÿæ˜¯æ•´ä¸ª <code class="language-plaintext highlighter-rouge">diff</code> è¿‡ç¨‹ä¸­æœ€é‡è¦çš„ç¯èŠ‚ï¼Œä»¥ä¸‹ä¸º <code class="language-plaintext highlighter-rouge">Vue.js</code> çš„æºç è¿‡ç¨‹ï¼Œä¸ºäº†æ›´å½¢è±¡ç†è§£ <code class="language-plaintext highlighter-rouge">diff</code> è¿‡ç¨‹ï¼Œæˆ‘ä»¬ç»™å‡ºç›¸å…³çš„ç¤ºæ„å›¾æ¥è®²è§£ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  function updateChildren (parentElm, oldCh, newCh, insertedVnodeQueue, removeOnly) {
    // ä¸ºoldChå’ŒnewChåˆ†åˆ«å»ºç«‹ç´¢å¼•ï¼Œä¸ºä¹‹åéå†çš„ä¾æ®
    let oldStartIdx = 0
    let newStartIdx = 0
    let oldEndIdx = oldCh.length - 1
    let oldStartVnode = oldCh[0]
    let oldEndVnode = oldCh[oldEndIdx]
    let newEndIdx = newCh.length - 1
    let newStartVnode = newCh[0]
    let newEndVnode = newCh[newEndIdx]
    let oldKeyToIdx, idxInOld, vnodeToMove, refElm

    // ç›´åˆ°oldChæˆ–è€…newChè¢«éå†å®Œåè·³å‡ºå¾ªç¯
    while (oldStartIdx &lt;= oldEndIdx &amp;&amp; newStartIdx &lt;= newEndIdx) {
      if (isUndef(oldStartVnode)) {
        oldStartVnode = oldCh[++oldStartIdx] // Vnode has been moved left
      } else if (isUndef(oldEndVnode)) {
        oldEndVnode = oldCh[--oldEndIdx]
      } else if (sameVnode(oldStartVnode, newStartVnode)) {
        patchVnode(oldStartVnode, newStartVnode, insertedVnodeQueue, newCh, newStartIdx)
        oldStartVnode = oldCh[++oldStartIdx]
        newStartVnode = newCh[++newStartIdx]
      } else if (sameVnode(oldEndVnode, newEndVnode)) {
        patchVnode(oldEndVnode, newEndVnode, insertedVnodeQueue, newCh, newEndIdx)
        oldEndVnode = oldCh[--oldEndIdx]
        newEndVnode = newCh[--newEndIdx]
      } else if (sameVnode(oldStartVnode, newEndVnode)) { // Vnode moved right
        patchVnode(oldStartVnode, newEndVnode, insertedVnodeQueue, newCh, newEndIdx)
        canMove &amp;&amp; nodeOps.insertBefore(parentElm, oldStartVnode.elm, nodeOps.nextSibling(oldEndVnode.elm))
        oldStartVnode = oldCh[++oldStartIdx]
        newEndVnode = newCh[--newEndIdx]
      } else if (sameVnode(oldEndVnode, newStartVnode)) { // Vnode moved left
        patchVnode(oldEndVnode, newStartVnode, insertedVnodeQueue, newCh, newStartIdx)
        canMove &amp;&amp; nodeOps.insertBefore(parentElm, oldEndVnode.elm, oldStartVnode.elm)
        oldEndVnode = oldCh[--oldEndIdx]
        newStartVnode = newCh[++newStartIdx]
      } else {
        if (isUndef(oldKeyToIdx)) oldKeyToIdx = createKeyToOldIdx(oldCh, oldStartIdx, oldEndIdx)
        idxInOld = isDef(newStartVnode.key)
          ? oldKeyToIdx[newStartVnode.key]
          : findIdxInOld(newStartVnode, oldCh, oldStartIdx, oldEndIdx)
        if (isUndef(idxInOld)) { // New element
          createElm(newStartVnode, insertedVnodeQueue, parentElm, oldStartVnode.elm, false, newCh, newStartIdx)
        } else {
          vnodeToMove = oldCh[idxInOld]
          if (sameVnode(vnodeToMove, newStartVnode)) {
            patchVnode(vnodeToMove, newStartVnode, insertedVnodeQueue, newCh, newStartIdx)
            oldCh[idxInOld] = undefined
            canMove &amp;&amp; nodeOps.insertBefore(parentElm, vnodeToMove.elm, oldStartVnode.elm)
          } else {
            // same key but different element. treat as new element
            createElm(newStartVnode, insertedVnodeQueue, parentElm, oldStartVnode.elm, false, newCh, newStartIdx)
          }
        }
        newStartVnode = newCh[++newStartIdx]
      }
    }
    if (oldStartIdx &gt; oldEndIdx) {
      refElm = isUndef(newCh[newEndIdx + 1]) ? null : newCh[newEndIdx + 1].elm
      addVnodes(parentElm, refElm, newCh, newStartIdx, newEndIdx, insertedVnodeQueue)
    } else if (newStartIdx &gt; newEndIdx) {
      removeVnodes(parentElm, oldCh, oldStartIdx, oldEndIdx)
    }
  }
å¤åˆ¶ä»£ç 
</code></pre></div></div>

<p>åœ¨å¼€å§‹éå† <code class="language-plaintext highlighter-rouge">diff</code> å‰ï¼Œé¦–å…ˆç»™ <code class="language-plaintext highlighter-rouge">oldCh</code>å’Œ <code class="language-plaintext highlighter-rouge">newCh</code> åˆ†åˆ«åˆ†é…ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">startIndex</code> å’Œ <code class="language-plaintext highlighter-rouge">endIndex</code> æ¥ä½œä¸ºéå†çš„ç´¢å¼•ï¼Œå½“<code class="language-plaintext highlighter-rouge">oldCh</code> æˆ–è€… <code class="language-plaintext highlighter-rouge">newCh</code> éå†å®Œå(éå†å®Œçš„æ¡ä»¶å°±æ˜¯ <code class="language-plaintext highlighter-rouge">oldCh</code> æˆ–è€… <code class="language-plaintext highlighter-rouge">newCh</code> çš„ <code class="language-plaintext highlighter-rouge">startIndex &gt;= endIndex</code> )ï¼Œå°±åœæ­¢<code class="language-plaintext highlighter-rouge">oldCh</code> å’Œ <code class="language-plaintext highlighter-rouge">newCh</code> çš„ <code class="language-plaintext highlighter-rouge">diff</code> è¿‡ç¨‹ã€‚æ¥ä¸‹æ¥é€šè¿‡å®ä¾‹æ¥çœ‹ä¸‹æ•´ä¸ª <code class="language-plaintext highlighter-rouge">diff</code> çš„è¿‡ç¨‹(èŠ‚ç‚¹å±æ€§ä¸­ä¸å¸¦ <code class="language-plaintext highlighter-rouge">key</code> çš„æƒ…å†µ)ã€‚</p>

<p><strong>ï¼ˆ2ï¼‰æ—  <code class="language-plaintext highlighter-rouge">key</code> çš„ <code class="language-plaintext highlighter-rouge">diff</code> è¿‡ç¨‹</strong></p>

<p>æˆ‘ä»¬é€šè¿‡ä»¥ä¸‹ç¤ºæ„å›¾å¯¹ä»¥ä¸Šä»£ç è¿‡ç¨‹è¿›è¡Œè®²è§£ï¼š</p>

<p>ï¼ˆ2.1ï¼‰é¦–å…ˆä»ç¬¬ä¸€ä¸ªèŠ‚ç‚¹å¼€å§‹æ¯”è¾ƒï¼Œä¸ç®¡æ˜¯ <code class="language-plaintext highlighter-rouge">oldCh</code> è¿˜æ˜¯ <code class="language-plaintext highlighter-rouge">newCh</code> çš„èµ·å§‹æˆ–è€…ç»ˆæ­¢èŠ‚ç‚¹éƒ½ä¸å­˜åœ¨ <code class="language-plaintext highlighter-rouge">sameVnode</code> ï¼ŒåŒæ—¶èŠ‚ç‚¹å±æ€§ä¸­æ˜¯ä¸å¸¦ <code class="language-plaintext highlighter-rouge">key</code>æ ‡è®°çš„ï¼Œå› æ­¤ç¬¬ä¸€è½®çš„ <code class="language-plaintext highlighter-rouge">diff</code> å®Œåï¼Œ<code class="language-plaintext highlighter-rouge">newCh</code>çš„ <code class="language-plaintext highlighter-rouge">startVnode</code> è¢«æ·»åŠ åˆ° <code class="language-plaintext highlighter-rouge">oldStartVnode</code>çš„å‰é¢ï¼ŒåŒæ—¶ <code class="language-plaintext highlighter-rouge">newStartIndex</code>å‰ç§»ä¸€ä½ï¼›</p>

<p><img src="https://user-gold-cdn.xitu.io/2019/7/23/16c1e0e2878c44dc?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="Ã¥Â›Â¾Ã§Â‰Â‡Ã¦ÂÂÃ¨Â¿Â°" /></p>

<p>ï¼ˆ2.2ï¼‰ç¬¬äºŒè½®çš„ <code class="language-plaintext highlighter-rouge">diff</code>ä¸­ï¼Œæ»¡è¶³ <code class="language-plaintext highlighter-rouge">sameVnode(oldStartVnode, newStartVnode)</code>ï¼Œå› æ­¤å¯¹è¿™2ä¸ª <code class="language-plaintext highlighter-rouge">vnode</code> è¿›è¡Œ<code class="language-plaintext highlighter-rouge">diff</code>ï¼Œæœ€åå°† <code class="language-plaintext highlighter-rouge">patch</code> æ‰“åˆ° <code class="language-plaintext highlighter-rouge">oldStartVnode</code> ä¸Šï¼ŒåŒæ—¶ <code class="language-plaintext highlighter-rouge">oldStartVnode</code>å’Œ <code class="language-plaintext highlighter-rouge">newStartIndex</code> éƒ½å‘å‰ç§»åŠ¨ä¸€ä½ ï¼›</p>

<p><img src="https://user-gold-cdn.xitu.io/2019/7/23/16c1e0e28889eaff?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="Ã¥Â›Â¾Ã§Â‰Â‡Ã¦ÂÂÃ¨Â¿Â°" /></p>

<p>ï¼ˆ2.3ï¼‰ç¬¬ä¸‰è½®çš„ <code class="language-plaintext highlighter-rouge">diff</code> ä¸­ï¼Œæ»¡è¶³ <code class="language-plaintext highlighter-rouge">sameVnode(oldEndVnode, newStartVnode)</code>ï¼Œé‚£ä¹ˆé¦–å…ˆå¯¹  <code class="language-plaintext highlighter-rouge">oldEndVnode</code>å’Œ<code class="language-plaintext highlighter-rouge">newStartVnode</code> è¿›è¡Œ <code class="language-plaintext highlighter-rouge">diff</code>ï¼Œå¹¶å¯¹ <code class="language-plaintext highlighter-rouge">oldEndVnode</code>è¿›è¡Œ <code class="language-plaintext highlighter-rouge">patch</code>ï¼Œå¹¶å®Œæˆ  <code class="language-plaintext highlighter-rouge">oldEndVnode</code> ç§»ä½çš„æ“ä½œï¼Œæœ€å<code class="language-plaintext highlighter-rouge">newStartIndex</code>å‰ç§»ä¸€ä½ï¼Œ<code class="language-plaintext highlighter-rouge">oldStartVnode</code> åç§»ä¸€ä½ï¼›</p>

<p><img src="https://user-gold-cdn.xitu.io/2019/7/23/16c1e0e289a351b2?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="Ã¥Â›Â¾Ã§Â‰Â‡Ã¦ÂÂÃ¨Â¿Â°" /></p>

<p>ï¼ˆ2.4ï¼‰ç¬¬å››è½®çš„ <code class="language-plaintext highlighter-rouge">diff</code>ä¸­ï¼Œè¿‡ç¨‹åŒæ­¥éª¤3ï¼›</p>

<p><img src="https://user-gold-cdn.xitu.io/2019/7/23/16c1e0e289f9213e?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="Ã¥Â›Â¾Ã§Â‰Â‡Ã¦ÂÂÃ¨Â¿Â°" /></p>

<p>ï¼ˆ2.5ï¼‰ç¬¬äº”è½®çš„ <code class="language-plaintext highlighter-rouge">diff</code> ä¸­ï¼ŒåŒè¿‡ç¨‹1ï¼›</p>

<p><img src="https://user-gold-cdn.xitu.io/2019/7/23/16c1e0e28aee99a1?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="Ã¥Â›Â¾Ã§Â‰Â‡Ã¦ÂÂÃ¨Â¿Â°" /></p>

<p>ï¼ˆ2.6ï¼‰éå†çš„è¿‡ç¨‹ç»“æŸåï¼Œ<code class="language-plaintext highlighter-rouge">newStartIdx &gt; newEndIdx</code>ï¼Œè¯´æ˜æ­¤æ—¶ <code class="language-plaintext highlighter-rouge">oldCh</code> å­˜åœ¨å¤šä½™çš„èŠ‚ç‚¹ï¼Œé‚£ä¹ˆæœ€åå°±éœ€è¦å°†è¿™äº›å¤šä½™çš„èŠ‚ç‚¹åˆ é™¤ã€‚</p>

<p><img src="https://user-gold-cdn.xitu.io/2019/7/23/16c1e0e2ca893b49?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="Ã¥Â›Â¾Ã§Â‰Â‡Ã¦ÂÂÃ¨Â¿Â°" /></p>

<p><strong>ï¼ˆ3ï¼‰æœ‰ <code class="language-plaintext highlighter-rouge">key</code> çš„ <code class="language-plaintext highlighter-rouge">diff</code> æµç¨‹</strong></p>

<p>åœ¨ <code class="language-plaintext highlighter-rouge">vnode</code> ä¸å¸¦ <code class="language-plaintext highlighter-rouge">key</code> çš„æƒ…å†µä¸‹ï¼Œæ¯ä¸€è½®çš„ <code class="language-plaintext highlighter-rouge">diff</code> è¿‡ç¨‹å½“ä¸­éƒ½æ˜¯<code class="language-plaintext highlighter-rouge">èµ·å§‹</code>å’Œ<code class="language-plaintext highlighter-rouge">ç»“æŸ</code>èŠ‚ç‚¹è¿›è¡Œæ¯”è¾ƒï¼Œç›´åˆ° <code class="language-plaintext highlighter-rouge">oldCh</code> æˆ–è€…<code class="language-plaintext highlighter-rouge">newCh</code> è¢«éå†å®Œã€‚è€Œå½“ä¸º <code class="language-plaintext highlighter-rouge">vnode</code> å¼•å…¥ <code class="language-plaintext highlighter-rouge">key</code> å±æ€§åï¼Œåœ¨æ¯ä¸€è½®çš„ <code class="language-plaintext highlighter-rouge">diff</code> è¿‡ç¨‹ä¸­ï¼Œå½“<code class="language-plaintext highlighter-rouge">èµ·å§‹</code>å’Œ<code class="language-plaintext highlighter-rouge">ç»“æŸ</code>èŠ‚ç‚¹éƒ½æ²¡æœ‰æ‰¾åˆ°<code class="language-plaintext highlighter-rouge">sameVnode</code> æ—¶ï¼Œç„¶åå†åˆ¤æ–­åœ¨ <code class="language-plaintext highlighter-rouge">newStartVnode</code> çš„å±æ€§ä¸­æ˜¯å¦æœ‰ <code class="language-plaintext highlighter-rouge">key</code>ï¼Œä¸”æ˜¯å¦åœ¨ <code class="language-plaintext highlighter-rouge">oldKeyToIndx</code> ä¸­æ‰¾åˆ°å¯¹åº”çš„èŠ‚ç‚¹ ï¼š</p>

<ul>
  <li>å¦‚æœä¸å­˜åœ¨è¿™ä¸ª <code class="language-plaintext highlighter-rouge">key</code>ï¼Œé‚£ä¹ˆå°±å°†è¿™ä¸ª <code class="language-plaintext highlighter-rouge">newStartVnode</code>ä½œä¸ºæ–°çš„èŠ‚ç‚¹åˆ›å»ºä¸”æ’å…¥åˆ°åŸæœ‰çš„ <code class="language-plaintext highlighter-rouge">root</code> çš„å­èŠ‚ç‚¹ä¸­ï¼›</li>
  <li>å¦‚æœå­˜åœ¨è¿™ä¸ª <code class="language-plaintext highlighter-rouge">key</code>ï¼Œé‚£ä¹ˆå°±å–å‡º <code class="language-plaintext highlighter-rouge">oldCh</code> ä¸­çš„å­˜åœ¨è¿™ä¸ª <code class="language-plaintext highlighter-rouge">key</code> çš„ <code class="language-plaintext highlighter-rouge">vnode</code>ï¼Œç„¶åå†è¿›è¡Œ <code class="language-plaintext highlighter-rouge">diff</code> çš„è¿‡ï¼›</li>
</ul>

<p>é€šè¿‡ä»¥ä¸Šåˆ†æï¼Œç»™<code class="language-plaintext highlighter-rouge">vdom</code>ä¸Šæ·»åŠ  <code class="language-plaintext highlighter-rouge">key</code>å±æ€§åï¼Œéå† <code class="language-plaintext highlighter-rouge">diff</code> çš„è¿‡ç¨‹ä¸­ï¼Œå½“<strong>èµ·å§‹ç‚¹</strong>ï¼Œ<strong>ç»“æŸç‚¹</strong>çš„<strong>æœå¯»</strong>åŠ <code class="language-plaintext highlighter-rouge">diff</code> å‡ºç°è¿˜æ˜¯æ— æ³•åŒ¹é…çš„æƒ…å†µä¸‹æ—¶ï¼Œå°±ä¼šç”¨ <code class="language-plaintext highlighter-rouge">key</code> æ¥ä½œä¸ºå”¯ä¸€æ ‡è¯†ï¼Œæ¥è¿›è¡Œ <code class="language-plaintext highlighter-rouge">diff</code>ï¼Œè¿™æ ·å°±å¯ä»¥æé«˜ <code class="language-plaintext highlighter-rouge">diff</code> æ•ˆç‡ã€‚</p>

<p>å¸¦æœ‰ <code class="language-plaintext highlighter-rouge">Key</code>å±æ€§çš„ <code class="language-plaintext highlighter-rouge">vnode</code>çš„ <code class="language-plaintext highlighter-rouge">diff</code> è¿‡ç¨‹å¯è§ä¸‹å›¾ï¼š</p>

<p>ï¼ˆ3.1ï¼‰é¦–å…ˆä»ç¬¬ä¸€ä¸ªèŠ‚ç‚¹å¼€å§‹æ¯”è¾ƒï¼Œä¸ç®¡æ˜¯ <code class="language-plaintext highlighter-rouge">oldCh</code> è¿˜æ˜¯ <code class="language-plaintext highlighter-rouge">newCh</code> çš„èµ·å§‹æˆ–è€…ç»ˆæ­¢èŠ‚ç‚¹éƒ½ä¸å­˜åœ¨ <code class="language-plaintext highlighter-rouge">sameVnode</code>ï¼Œä½†èŠ‚ç‚¹å±æ€§ä¸­æ˜¯å¸¦ <code class="language-plaintext highlighter-rouge">key</code> æ ‡è®°çš„ï¼Œ ç„¶ååœ¨ <code class="language-plaintext highlighter-rouge">oldKeyToIndx</code> ä¸­æ‰¾åˆ°å¯¹åº”çš„èŠ‚ç‚¹ï¼Œè¿™æ ·ç¬¬ä¸€è½® <code class="language-plaintext highlighter-rouge">diff</code> è¿‡å <code class="language-plaintext highlighter-rouge">oldCh</code> ä¸Šçš„<code class="language-plaintext highlighter-rouge">BèŠ‚ç‚¹</code>è¢«åˆ é™¤äº†ï¼Œä½†æ˜¯ <code class="language-plaintext highlighter-rouge">newCh</code> ä¸Šçš„<code class="language-plaintext highlighter-rouge">BèŠ‚ç‚¹</code>ä¸Š <code class="language-plaintext highlighter-rouge">elm</code> å±æ€§ä¿æŒå¯¹ <code class="language-plaintext highlighter-rouge">oldCh</code> ä¸Š <code class="language-plaintext highlighter-rouge">BèŠ‚ç‚¹</code> çš„<code class="language-plaintext highlighter-rouge">elm</code>å¼•ç”¨ã€‚</p>

<p><img src="data:image/svg+xml;utf8,&lt;?xml version=&quot;1.0&quot;?&gt;&lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; version=&quot;1.1&quot; width=&quot;800&quot; height=&quot;402&quot;&gt;&lt;/svg&gt;" alt="Ã¥Â›Â¾Ã§Â‰Â‡Ã¦ÂÂÃ¨Â¿Â°" /></p>

<p>ï¼ˆ3.2ï¼‰ç¬¬äºŒè½®çš„ <code class="language-plaintext highlighter-rouge">diff</code> ä¸­ï¼Œæ»¡è¶³ <code class="language-plaintext highlighter-rouge">sameVnode(oldStartVnode, newStartVnode)</code>ï¼Œå› æ­¤å¯¹è¿™2ä¸ª <code class="language-plaintext highlighter-rouge">vnode</code> è¿›è¡Œ<code class="language-plaintext highlighter-rouge">diff</code>ï¼Œæœ€åå°† <code class="language-plaintext highlighter-rouge">patch</code> æ‰“åˆ° <code class="language-plaintext highlighter-rouge">oldStartVnode</code>ä¸Šï¼ŒåŒæ—¶ <code class="language-plaintext highlighter-rouge">oldStartVnode</code> å’Œ <code class="language-plaintext highlighter-rouge">newStartIndex</code> éƒ½å‘å‰ç§»åŠ¨ä¸€ä½ ï¼›</p>

<p><img src="data:image/svg+xml;utf8,&lt;?xml version=&quot;1.0&quot;?&gt;&lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; version=&quot;1.1&quot; width=&quot;800&quot; height=&quot;412&quot;&gt;&lt;/svg&gt;" alt="Ã¥Â›Â¾Ã§Â‰Â‡Ã¦ÂÂÃ¨Â¿Â°" /></p>

<p>ï¼ˆ3.3ï¼‰ç¬¬ä¸‰è½®çš„ <code class="language-plaintext highlighter-rouge">diff</code>ä¸­ï¼Œæ»¡è¶³ <code class="language-plaintext highlighter-rouge">sameVnode(oldEndVnode, newStartVnode)</code>ï¼Œé‚£ä¹ˆé¦–å…ˆå¯¹ <code class="language-plaintext highlighter-rouge">oldEndVnode</code> å’Œ<code class="language-plaintext highlighter-rouge">newStartVnode</code> è¿›è¡Œ <code class="language-plaintext highlighter-rouge">diff</code>ï¼Œå¹¶å¯¹ <code class="language-plaintext highlighter-rouge">oldEndVnode</code> è¿›è¡Œ <code class="language-plaintext highlighter-rouge">patch</code>ï¼Œå¹¶å®Œæˆ <code class="language-plaintext highlighter-rouge">oldEndVnode</code> ç§»ä½çš„æ“ä½œï¼Œæœ€å<code class="language-plaintext highlighter-rouge">newStartIndex</code> å‰ç§»ä¸€ä½ï¼Œ<code class="language-plaintext highlighter-rouge">oldStartVnode</code>åç§»ä¸€ä½ï¼›</p>

<p><img src="https://user-gold-cdn.xitu.io/2019/7/23/16c1e0e2e2a2835e?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="Ã¥Â›Â¾Ã§Â‰Â‡Ã¦ÂÂÃ¨Â¿Â°" /></p>

<p>ï¼ˆ3.4ï¼‰ç¬¬å››è½®çš„<code class="language-plaintext highlighter-rouge">diff</code>ä¸­ï¼Œè¿‡ç¨‹åŒæ­¥éª¤2ï¼›</p>

<p><img src="https://user-gold-cdn.xitu.io/2019/7/23/16c1e0e2e507aec0?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="Ã¥Â›Â¾Ã§Â‰Â‡Ã¦ÂÂÃ¨Â¿Â°" /></p>

<p>ï¼ˆ3.5ï¼‰ç¬¬äº”è½®çš„<code class="language-plaintext highlighter-rouge">diff</code>ä¸­ï¼Œå› ä¸ºæ­¤æ—¶ <code class="language-plaintext highlighter-rouge">oldStartIndex</code> å·²ç»å¤§äº <code class="language-plaintext highlighter-rouge">oldEndIndex</code>ï¼Œæ‰€ä»¥å°†å‰©ä½™çš„ <code class="language-plaintext highlighter-rouge">Vnode</code> é˜Ÿåˆ—æ’å…¥é˜Ÿåˆ—æœ€åã€‚</p>

<p><img src="https://user-gold-cdn.xitu.io/2019/7/23/16c1e0e3178398fc?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="Ã¥Â›Â¾Ã§Â‰Â‡Ã¦ÂÂÃ¨Â¿Â°" /></p>

<h3 id="33patch-è¿‡ç¨‹">3.3ã€<code class="language-plaintext highlighter-rouge">patch</code> è¿‡ç¨‹</h3>

<p>é€šè¿‡3.2ç« èŠ‚ä»‹ç»çš„ <code class="language-plaintext highlighter-rouge">diff</code> è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ° <code class="language-plaintext highlighter-rouge">nodeOps</code> ç›¸å…³çš„æ–¹æ³•å¯¹çœŸå® <code class="language-plaintext highlighter-rouge">DOM</code> ç»“æ„è¿›è¡Œæ“ä½œï¼Œ<code class="language-plaintext highlighter-rouge">nodeOps</code> å®šä¹‰åœ¨ <code class="language-plaintext highlighter-rouge">src/platforms/web/runtime/node-ops.js</code> ä¸­ï¼Œå…¶ä¸ºåŸºæœ¬ <code class="language-plaintext highlighter-rouge">DOM</code> æ“ä½œï¼Œè¿™é‡Œå°±ä¸åœ¨è¯¦ç»†ä»‹ç»ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export function createElementNS (namespace: string, tagName: string): Element {
  return document.createElementNS(namespaceMap[namespace], tagName)
}

export function createTextNode (text: string): Text {
  return document.createTextNode(text)
}

export function createComment (text: string): Comment {
  return document.createComment(text)
}

export function insertBefore (parentNode: Node, newNode: Node, referenceNode: Node) {
  parentNode.insertBefore(newNode, referenceNode)
}

export function removeChild (node: Node, child: Node) {
  node.removeChild(child)
}
å¤åˆ¶ä»£ç 
</code></pre></div></div>

<h3 id="34æ€»ç»“">3.4ã€æ€»ç»“</h3>

<p>é€šè¿‡å‰ä¸‰å°èŠ‚ç®€æï¼Œæˆ‘ä»¬ä»ä¸»çº¿ä¸ŠæŠŠæ¨¡æ¿å’Œæ•°æ®å¦‚ä½•æ¸²æŸ“æˆæœ€ç»ˆçš„ <code class="language-plaintext highlighter-rouge">DOM</code> çš„è¿‡ç¨‹åˆ†æå®Œæ¯•äº†ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹å›¾æ›´ç›´è§‚åœ°çœ‹åˆ°ä»åˆå§‹åŒ– <code class="language-plaintext highlighter-rouge">Vue</code> åˆ°æœ€ç»ˆæ¸²æŸ“çš„æ•´ä¸ªè¿‡ç¨‹ã€‚</p>

<p><img src="https://user-gold-cdn.xitu.io/2019/7/23/16c1e2486c7e0ed7?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img" /></p>

<h2 id="å››æ€»ç»“">å››ã€æ€»ç»“</h2>

<p>æœ¬æ–‡ä»é€šè¿‡ä»‹ç»çœŸå® <code class="language-plaintext highlighter-rouge">DOM</code> ç»“æ„å…¶è§£æè¿‡ç¨‹ä»¥åŠå­˜åœ¨çš„é—®é¢˜ï¼Œä»è€Œå¼•å‡ºä¸ºä»€ä¹ˆéœ€è¦è™šæ‹Ÿ <code class="language-plaintext highlighter-rouge">DOM</code>ï¼›ç„¶ååˆ†æè™šæ‹Ÿ<code class="language-plaintext highlighter-rouge">DOM</code> çš„å¥½å¤„ï¼Œä»¥åŠå…¶ä¸€äº›ç†è®ºåŸºç¡€å’ŒåŸºç¡€ç®—æ³•çš„å®ç°ï¼›æœ€åæ ¹æ®æˆ‘ä»¬å·²ç»æŒæ¡çš„åŸºç¡€çŸ¥è¯†ï¼Œå†ä¸€æ­¥æ­¥å»æŸ¥çœ‹<code class="language-plaintext highlighter-rouge">Vue.js</code> çš„æºç å¦‚ä½•å®ç°çš„ã€‚ä»å­˜åœ¨é—®é¢˜ â€”&gt; ç†è®ºåŸºç¡€ â€”&gt; å…·ä½“å®è·µï¼Œä¸€æ­¥æ­¥æ·±å…¥ï¼Œå¸®åŠ©å¤§å®¶æ›´å¥½çš„äº†è§£ä»€ä¹ˆæ˜¯<code class="language-plaintext highlighter-rouge">Virtual DOM</code>ã€ä¸ºä»€ä¹ˆéœ€è¦ <code class="language-plaintext highlighter-rouge">Virtual DOM</code>ã€ä»¥åŠ <code class="language-plaintext highlighter-rouge">Virtual DOM</code>çš„å…·ä½“å®ç°ï¼Œå¸Œæœ›æœ¬æ–‡å¯¹æ‚¨æœ‰å¸®åŠ©ã€‚</p>

<p><strong>è¾›è‹¦ç¼–å†™è‰¯ä¹…ï¼Œå¦‚æœå¯¹ä½ æœ‰å¸®åŠ©ï¼Œè¿˜æœ›æ‰‹åŠ¨ç‚¹èµé¼“åŠ±~~~~~~</strong></p>

<p><strong>githubåœ°å€ä¸ºï¼š<a href="https://github.com/fengshi123/blog">github.com/fengshi123/â€¦</a>ï¼Œä¸Šé¢æ±‡æ€»äº†ä½œè€…æ‰€æœ‰çš„åšå®¢æ–‡ç« ï¼Œå¦‚æœå–œæ¬¢æˆ–è€…æœ‰æ‰€å¯å‘ï¼Œè¯·å¸®å¿™ç»™ä¸ª star ~ï¼Œå¯¹ä½œè€…ä¹Ÿæ˜¯ä¸€ç§é¼“åŠ±ã€‚</strong></p>

<p><a href="https://juejin.im/post/6844903895467032589">Link</a></p>
:ET